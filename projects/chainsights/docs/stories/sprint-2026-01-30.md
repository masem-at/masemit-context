---
title: Sprint Stories 2026-01-30
author: Paige (Technical Writer)
date: 2026-01-30
source: Party Mode discussion (Winston, Pixel, Paige + Mario)
context: docs/project_context.md
status: ready-for-dev
---

# Sprint Stories — 2026-01-30

> **Single Source of Truth:** `docs/project_context.md` — load before any implementation.

---

## Story A: Pricing Page

**Goal:** Static pricing overview page so users can compare tiers before entering checkout.

**Acceptance Criteria:**

- [ ] New page at `/pricing` as Server Component (no `'use client'`)
- [ ] Display three tiers from `PRICING_CONFIG` (`src/lib/config/pricing.ts`):
  - Free Check (€0) — CTA opens Report Selection Modal or links to `/quiz`
  - Deep Dive (€49) — badge "Most Popular" — CTA links to checkout
  - Governance Audit (€149) — badge "Complete Analysis" — CTA links to checkout
- [ ] Use existing `PRICING_CONFIG.tiers` and `ACTIVE_TIERS` from `src/lib/stripe.ts`
- [ ] Track `cta_view` event (IntersectionObserver) with `button_name: 'pricing_tier'`
- [ ] Track `cta_click` event per tier with `location: 'pricing'`
- [ ] Add "Pricing" link to header nav in `src/components/header.tsx` (NAV_LINKS array)
- [ ] Responsive: card layout on mobile, side-by-side on desktop
- [ ] SEO: proper meta title/description

**Files to modify:**

- Create: `src/app/pricing/page.tsx`
- Modify: `src/components/header.tsx` (add nav link)
- Reference: `src/lib/config/pricing.ts`, `src/lib/stripe.ts` (tier data)
- Reference: `src/lib/analytics.ts` (event tracking)

**Notes:**

- No auth required
- No database queries needed
- Follow existing design patterns (navy/aqua theme, Tailwind classes)

---

## Story B: Stripe Customer Portal Integration

**Goal:** Let paying customers manage their subscription (invoices, cancel, payment method) via Stripe Customer Portal.

**Acceptance Criteria:**

- [ ] New API route `POST /api/billing-portal` that:
  - Accepts `{ stripeCustomerId: string }` in request body
  - Validates with Zod schema
  - Calls `stripe.billingPortal.sessions.create({ customer: stripeCustomerId, return_url })`
  - Returns `{ url: string }` — the portal session URL
  - Returns 400 if `stripeCustomerId` is missing/invalid
  - Returns 500 with generic error if Stripe fails
- [ ] Add portal link to report delivery email in `src/lib/email/index.ts`:
  - After the download links section, add: "Manage your subscription: [Link]"
  - Generate portal session URL using the order's `stripeCustomerId`
  - Only show for paid orders (not free checks)
- [ ] Add portal link to recovery email in `src/lib/email/index.ts` (`sendRecoveryEmail`)

**Files to modify:**

- Create: `src/app/api/billing-portal/route.ts`
- Modify: `src/lib/email/index.ts` (add portal link to `sendReportEmail` and `sendRecoveryEmail`)
- Reference: `src/lib/stripe.ts` (stripe instance import)
- Reference: `src/lib/db/schema.ts` (orders table — `stripeCustomerId` column)

**Notes:**

- Stripe Customer Portal must be configured in Stripe Dashboard (Settings → Billing → Customer Portal)
- Portal session URLs expire after 24h — fine for emails sent at delivery time
- No custom auth needed — the portal link IS the auth (Stripe handles it)

---

## Story C: /account Fallback Page

**Goal:** Fallback page for customers who lost their email — enter email, receive fresh portal link.

**Acceptance Criteria:**

- [ ] New page at `/account` as Client Component (needs form interaction)
- [ ] Simple form: email input + submit button
- [ ] On submit, calls `POST /api/account-lookup` with `{ email: string }`
- [ ] API route `POST /api/account-lookup`:
  - Validates email with Zod
  - Queries `orders` table for matching `customerEmail` with status `paid` or later
  - If found: gets `stripeCustomerId`, generates portal session URL, sends email via Resend
  - Returns generic success message regardless of match (prevent email enumeration)
  - Rate limit: max 3 requests per email per hour
- [ ] Success UI: "If an account exists for this email, we've sent you a link to manage your subscription."
- [ ] Track `cta_click` event with `button_name: 'account_lookup'`, `location: 'account'`

**Files to modify:**

- Create: `src/app/account/page.tsx`
- Create: `src/app/api/account-lookup/route.ts`
- Reference: `src/lib/stripe.ts` (stripe instance)
- Reference: `src/lib/db/schema.ts` (orders table)
- Reference: `src/lib/email/index.ts` (send email with portal link)

**Security considerations:**

- NEVER reveal whether an email exists in the system
- Always return the same success message
- Rate limit to prevent abuse
- Send portal link via email, never display directly in browser

---

## Story D: Rankings Daily Update

**Goal:** Switch rankings from weekly to daily, derive from existing GVS snapshots.

**Acceptance Criteria:**

- [ ] Modify rankings generation to run daily instead of weekly
- [ ] Rankings derived from `gvs_snapshots` table (already populated daily) instead of fresh Snapshot API calls
- [ ] Query: latest `gvs_snapshot` per DAO (where `snapshotType = 'daily'`), ordered by `gvsScore` DESC
- [ ] Output: updated `data/rankings.json` with same structure as current
- [ ] Update Vercel cron schedule from weekly to daily
- [ ] Delta calculation: compare today's score to yesterday's snapshot (not last week's)
- [ ] Verify no Snapshot API rate limit issues (should be zero additional calls)

**Files to investigate:**

- Rankings generation script/cron (find current implementation)
- `vercel.json` (cron schedule)
- `data/rankings.json` (output format)
- `src/lib/db/schema.ts` (gvs_snapshots table, lines 373-402)
- `src/lib/db/queries/leaderboard.ts` (if rankings are queried from DB)

**Notes:**

- This is a separate track from Stories A-C
- No user-facing UI changes needed
- Existing rankings page will automatically show fresher data
- ISR cache (`revalidate = 3600`) remains appropriate — 1h cache on daily data is fine

---

## Story E: Move Header to Root Layout (Refactor)

**Goal:** Eliminate per-page Header imports by moving `<Header />` into the root layout. Prevents future pages from accidentally missing navigation.

**Acceptance Criteria:**

- [ ] Add `<Header />` import and render in `src/app/layout.tsx` (above `{children}`)
- [ ] Remove `<Header />` import and render from all individual pages:
  - `src/app/page.tsx` (home)
  - `src/app/rankings/page.tsx`
  - `src/app/rankings/opt-out/page.tsx`
  - `src/app/rankings/methodology/page.tsx`
  - `src/app/quiz/page.tsx` (3 instances)
  - `src/app/guide/page.tsx`
  - `src/app/impact/page.tsx`
  - `src/app/terms/page.tsx`
  - `src/app/privacy/page.tsx`
  - `src/app/accessibility/page.tsx`
  - `src/app/imprint/page.tsx`
  - `src/app/matrix/page.tsx` (just added as quick-fix)
- [ ] Verify Header does NOT appear on admin pages (`/admin/*`) — may need a route group `(public)` or conditional logic
- [ ] Verify no double-Header rendering on any page
- [ ] Visual regression check: all pages look correct with layout-level Header
- [ ] Header `fixed top-0` positioning still works correctly

**Files to modify:**

- Modify: `src/app/layout.tsx` (add Header)
- Modify: 12+ page files (remove Header import + render)
- Investigate: Admin pages — ensure no Header on `/admin/*`

**Notes:**

- This is a refactor, not a feature — no new functionality
- Risk: Admin pages must NOT get the public Header
- Consider using Next.js Route Groups: `(public)/` for Header pages vs `(admin)/` for admin

---

## Implementation Order

1. **Story A** (Pricing Page) — no dependencies, immediate value
2. **Story B** (Stripe Portal in emails) — needs Stripe Dashboard config
3. **Story C** (/account fallback) — depends on Story B API route
4. **Story D** (Daily rankings) — independent, parallel track
5. **Story E** (Header to layout refactor) — independent, low priority
