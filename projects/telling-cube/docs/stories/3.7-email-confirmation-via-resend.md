# Story 3.7: Email Confirmation via Resend

## Status
Draft

## Story
**As a** founding member,
**I want** to receive a confirmation email after payment,
**so that** I have a receipt and access instructions in my inbox.

## Acceptance Criteria

1. Resend configured with API key in environment variables (`RESEND_API_KEY`)
2. Email template created with:
   - Subject: "Welcome to tellingCube - Founding Member Confirmed"
   - Body: Thank you message, tier purchased, amount paid, access instructions ("Visit tellingcube.com anytime")
   - Footer: Support email contact
3. Stripe webhook endpoint `/api/stripe/webhook` created to listen for `checkout.session.completed` event
4. On successful payment event: extract customer email from Stripe session and send confirmation email via Resend
5. Manual test in Stripe test mode: complete checkout → confirmation email received within 1 minute

## Tasks / Subtasks

- [ ] Set Up Resend Account - **MANUAL SETUP REQUIRED**
  - [ ] Create account at resend.com
  - [ ] Verify domain (or use Resend test domain for MVP)
  - [ ] Copy API key
  - [ ] Add to `.env.local`: `RESEND_API_KEY=re_...`

- [ ] Install Resend SDK
  - [ ] Run: `pnpm add resend`

- [ ] Create Email Template (AC: 2)
  - [ ] Create `lib/email/templates/founding-member-confirmation.ts`:
    ```typescript
    export const foundingMemberEmail = (tier: string, amount: number) => ({
      subject: 'Welcome to tellingCube - Founding Member Confirmed',
      html: `
        <h1>Welcome to tellingCube!</h1>
        <p>Thank you for becoming a ${tier} founding member.</p>
        <p><strong>Amount paid:</strong> €${amount}</p>
        <p><strong>Access:</strong> Visit tellingcube.com anytime to generate unlimited scenarios.</p>
        <p>Questions? Email support@tellingcube.com</p>
      `
    })
    ```

- [ ] Create Stripe Webhook Endpoint (AC: 3, 4)
  - [ ] Create `app/api/stripe/webhook/route.ts`
  - [ ] Verify webhook signature:
    ```typescript
    const sig = headers().get('stripe-signature')!
    const event = stripe.webhooks.constructEvent(body, sig, process.env.STRIPE_WEBHOOK_SECRET!)
    ```
  - [ ] Handle `checkout.session.completed` event:
    ```typescript
    if (event.type === 'checkout.session.completed') {
      const session = event.data.object
      await sendConfirmationEmail(session.customer_email, session.amount_total)
    }
    ```

- [ ] Implement Email Sending (AC: 4)
  - [ ] Create `lib/email/send-confirmation.ts`:
    ```typescript
    import { Resend } from 'resend'
    const resend = new Resend(process.env.RESEND_API_KEY)

    export async function sendConfirmationEmail(email: string, tier: string, amount: number) {
      const template = foundingMemberEmail(tier, amount)
      await resend.emails.send({
        from: 'tellingCube <noreply@tellingcube.com>',
        to: email,
        subject: template.subject,
        html: template.html
      })
    }
    ```

- [ ] Configure Webhook in Stripe Dashboard - **MANUAL SETUP**
  - [ ] Add webhook URL: `https://tellingcube.com/api/stripe/webhook`
  - [ ] Select event: `checkout.session.completed`
  - [ ] Copy webhook secret
  - [ ] Add to `.env.local`: `STRIPE_WEBHOOK_SECRET=whsec_...`

- [ ] Testing (AC: 5)
  - [ ] Use Stripe CLI for local testing:
    ```bash
    stripe listen --forward-to localhost:3000/api/stripe/webhook
    stripe trigger checkout.session.completed
    ```
  - [ ] Complete test payment via Story 3.5
  - [ ] Verify email received within 1 minute
  - [ ] Check email content (tier, amount, instructions)

## Dev Notes

### Resend Configuration
[Source: docs/architecture/tech-stack.md - Resend]
- Vercel-native email service
- Free tier: 100 emails/day
- Simple API, reliable delivery
- Test mode for development

### Stripe Webhook Security
```typescript
import Stripe from 'stripe'

export async function POST(request: Request) {
  const body = await request.text()
  const sig = request.headers.get('stripe-signature')!

  try {
    const event = stripe.webhooks.constructEvent(
      body,
      sig,
      process.env.STRIPE_WEBHOOK_SECRET!
    )

    if (event.type === 'checkout.session.completed') {
      const session = event.data.object as Stripe.Checkout.Session
      // Send email
    }

    return Response.json({ received: true })
  } catch (err) {
    return Response.json({ error: 'Webhook error' }, { status: 400 })
  }
}
```

### Environment Variables
```bash
RESEND_API_KEY=re_...
STRIPE_WEBHOOK_SECRET=whsec_...
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-19 | 1.0 | Initial story draft for Epic 3 | Bob (Scrum Master) |
