# Story 1.5: Event Storage & Scenario Management

## Status
Done

## Story
**As a** developer,
**I want** functions to store generated events and manage scenarios by unique ID,
**so that** generated data persists and can be retrieved for viewing.

## Acceptance Criteria
1. Utility function `lib\data\event-repository.ts` created with `insertEvents(scenarioId: string, events: Event[])` method using Prisma batch insert
2. Scenario ID generation implemented using UUID v4 (unique identifier for each generation)
3. Function `getEventsByScenario(scenarioId: string)` retrieves all events for a given scenario, ordered by event_date
4. Function `deleteScenarioEvents(scenarioId: string)` removes all events for a scenario (for cleanup/testing)
5. Test demonstrates: inserting 200 events, retrieving them by scenario ID, and verifying count and order are correct

## Tasks / Subtasks

- [x] Create event repository file structure (AC: 1)
  - [x] Create directory `lib/data` if not exists
  - [x] Create file `lib/data/event-repository.ts`
  - [x] Import Prisma client (`@/prisma/client` or initialize PrismaClient)
  - [x] Add TypeScript types for Event model (import from Prisma generated types)

- [x] Implement UUID v4 scenario ID generation (AC: 2)
  - [x] Install `uuid` package if not present: `pnpm add uuid` and `pnpm add -D @types/uuid`
  - [x] Create function `generateScenarioId(): string` that returns `uuidv4()`
  - [x] Export function for use in other modules

- [x] Implement insertEvents function with Prisma batch insert (AC: 1)
  - [x] Create `insertEvents(scenarioId: string, events: Event[]): Promise<number>` function
  - [x] Use `prisma.event.createMany({ data: events })` for efficient batch insert
  - [x] Add error handling for database constraint violations (duplicate IDs, missing scenario)
  - [x] Return count of inserted events
  - [x] Add JSDoc comments explaining function purpose and parameters

- [x] Implement getEventsByScenario retrieval function (AC: 3)
  - [x] Create `getEventsByScenario(scenarioId: string): Promise<Event[]>` function
  - [x] Use `prisma.event.findMany({ where: { scenarioId }, orderBy: { eventDate: 'asc' } })`
  - [x] Add error handling for database connection failures
  - [x] Return empty array if no events found (not an error state)
  - [x] Add JSDoc comments

- [x] Implement deleteScenarioEvents cleanup function (AC: 4)
  - [x] Create `deleteScenarioEvents(scenarioId: string): Promise<number>` function
  - [x] Use `prisma.event.deleteMany({ where: { scenarioId } })`
  - [x] Return count of deleted events
  - [x] Add error handling for database failures
  - [x] Add JSDoc comments

- [x] Create manual test script (AC: 5)
  - [x] Create test file `scripts/test-event-repository.ts` or use API route `app/api/test-event-storage/route.ts`
  - [x] Generate 200 sample events with varying dates (spread across 12 months)
  - [x] Call `insertEvents()` with generated scenario ID and events
  - [x] Call `getEventsByScenario()` to retrieve events
  - [x] Verify: event count === 200
  - [x] Verify: events are ordered by eventDate (ascending)
  - [x] Verify: all events have matching scenarioId
  - [x] Log results to console with ‚úÖ/‚ùå indicators
  - [x] Call `deleteScenarioEvents()` for cleanup
  - [x] Verify: deletion count === 200

## Dev Notes

### Previous Story Insights
[Source: Story 1.4 Dev Agent Record]

**Key Learnings from Story 1.4:**
- Quarterly batching pattern successfully solved Claude API token limits (81 events generated across Q1-Q4)
- Error handling with fallback strategies is critical (4-tier JSON parsing in parseClaudeJSON)
- Manual testing is acceptable and comprehensive for PoC scope (no automated tests required yet)
- TypeScript `any` typing is acceptable for PoC but noted for future production improvement
- Event generation produces realistic data: 18-23 events per quarter with proper date distribution

**Story 1.5 builds on Story 1.4 by:**
- Persisting the generated events (from Story 1.4) to the database
- Enabling retrieval of stored events for future viewing/dashboards
- Implementing scenario management to handle multiple generated datasets

### Data Models
[Source: docs/architecture.md#Data Models, lines 270-363]

**Event Model (Prisma Schema):**
```prisma
model Event {
  id                String    @id @default(uuid())
  scenarioId        String
  eventType         String    // EventType enum
  eventDate         DateTime

  // Dimensions (standardized across all events)
  timePeriod        String    // "2024-01" format for grouping
  organizationUnit  String?
  productId         String?
  counterpartyId    String?   // Customer, employee, or supplier ID
  assetId           String?

  // Financial attributes (nullable - only for financial events)
  amountEur         Decimal?  @db.Decimal(12, 2)
  quantity          Decimal?  @db.Decimal(10, 2)
  unitPrice         Decimal?  @db.Decimal(10, 2)

  // Metadata (flexible JSON for event-specific attributes)
  metadata          Json      @default("{}")

  createdAt         DateTime  @default(now())

  // Relationships
  scenario          Scenario  @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  // Indexes for query performance
  @@index([scenarioId])
  @@index([eventType])
  @@index([eventDate])
  @@index([timePeriod])
  @@index([scenarioId, eventType])
  @@index([scenarioId, timePeriod])

  @@map("events")
}
```

**Key Design Points:**
- Wide table schema with nullable columns for different event types
- JSON metadata field for event-specific attributes beyond standard fields
- 5 dimensions: Time (timePeriod), Organization, Product, Counterparty, Asset
- Decimal type for financial precision (12 digits, 2 decimal places)
- Cascade delete: when Scenario is deleted, all related Events are auto-deleted

**Scenario Model (Metadata Container):**
[Source: docs/architecture.md#Database Schema, lines 731-757]
```prisma
model Scenario {
  id                String    @id @default(uuid())
  scenarioType      String    // 'bakery' | 'hotel' | 'tech_startup'
  status            String    @default("processing") // 'processing' | 'completed' | 'error'

  // Metadata
  companyName       String?
  employeeCount     Int?
  timePeriodStart   DateTime
  timePeriodEnd     DateTime

  // Validation
  validationPassed  Boolean   @default(false)
  validationErrors  String[]  @default([])

  // Timestamps
  createdAt         DateTime  @default(now())
  completedAt       DateTime?
  expiresAt         DateTime  // 24 hours from createdAt

  // Relationships
  events            Event[]

  // Indexes
  @@index([status])
  @@index([expiresAt])
  @@index([createdAt])
}
```

**Important Notes:**
- Story 1.5 focuses ONLY on Event storage functions (insertEvents, getEventsByScenario, deleteScenarioEvents)
- Scenario model management (creating scenarios, updating status) will be handled in future stories
- For Story 1.5 testing, you can assume a valid scenarioId already exists or create test scenarios manually

### Database Context
[Source: docs/architecture.md#Database Schema]

**Prisma Client Usage:**
- Import from `@prisma/client` or use singleton pattern for Next.js
- Batch inserts use `prisma.event.createMany({ data: events })`
- Queries use `prisma.event.findMany({ where, orderBy })`
- Deletes use `prisma.event.deleteMany({ where })`

**Indexes for Performance:**
- `scenarioId` index enables fast retrieval by scenario
- `eventDate` index enables fast chronological ordering
- Composite indexes (`scenarioId + eventType`, `scenarioId + timePeriod`) optimize dashboard queries

**Error Handling:**
- Prisma throws `PrismaClientKnownRequestError` for constraint violations
- Catch errors and return meaningful messages (don't expose raw Prisma errors to callers)
- Database connection failures should be caught and logged

### File Locations
[Source: Story 1.5 PRD Acceptance Criteria + Story 1.4 project structure]

**Primary Implementation:**
- `lib/data/event-repository.ts` - Event storage functions (insertEvents, getEventsByScenario, deleteScenarioEvents, generateScenarioId)

**Testing:**
- Option 1: `scripts/test-event-repository.ts` - Standalone test script (run with `tsx` or `ts-node`)
- Option 2: `app/api/test-event-storage/route.ts` - API route for browser-based testing

**Dependencies to Import:**
- Prisma Client: `import { PrismaClient } from '@prisma/client'` or `import prisma from '@/lib/prisma'` (if singleton exists)
- UUID: `import { v4 as uuidv4 } from 'uuid'`
- Types: `import type { Event } from '@prisma/client'` (Prisma auto-generates from schema)

### Testing Requirements
[Source: docs/architecture.md#Testing Strategy, lines 1924-1950]

**PoC Testing Approach (Manual):**
- Manual test checklist acceptable for PoC scope (no automated unit tests required yet)
- Test script should log results to console with clear ‚úÖ/‚ùå indicators
- Focus on validating AC requirements directly

**Story 1.5 Manual Test Checklist:**
1. ‚úÖ Insert 200 events with same scenarioId ‚Üí verify insertEvents returns count 200
2. ‚úÖ Retrieve events by scenarioId ‚Üí verify getEventsByScenario returns array of 200 events
3. ‚úÖ Verify events ordered by eventDate ascending (first event date <= last event date)
4. ‚úÖ Verify all events have matching scenarioId field
5. ‚úÖ Delete events by scenarioId ‚Üí verify deleteScenarioEvents returns count 200
6. ‚úÖ Retrieve again ‚Üí verify getEventsByScenario returns empty array

**Test Data Generation:**
- Generate 200 events with random dates spread across 2024 (Jan-Dec)
- Use realistic eventTypes from Event model: employee_lifecycle, sales_transaction, cash_movement, operational_work, procurement, asset_lifecycle, planning_budgeting
- Include financial attributes (amountEur, quantity, unitPrice) for some events
- Ensure all events have required fields: eventType, eventDate, timePeriod

### Technical Constraints
[Source: docs/architecture.md#Coding Standards]

**TypeScript Configuration:**
- Strict mode enabled (`strict: true` in tsconfig.json)
- Use explicit return types for all exported functions
- No `any` types where possible (use Prisma-generated types for Event)

**Next.js 14 App Router:**
- Use `@/` import alias for absolute imports (e.g., `@/lib/data/event-repository`)
- Server-side only for database operations (Prisma client cannot run in browser)

**Error Handling:**
- Use try-catch blocks for all Prisma operations
- Return meaningful error objects or throw typed errors
- Log errors to console (console.error) for debugging during PoC

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-11-17 | 1.1 | Implementation completed - All tasks done, 6/6 tests passed | James (Developer) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
**TypeScript Type Fixes:**
- Fixed Prisma Decimal type usage in test route (line 49-55 of app/api/test-event-storage/route.ts)
- Fixed metadata JsonValue ‚Üí InputJsonValue type casting in event-repository.ts (line 39)
- All TypeScript strict mode checks pass (0 errors in Story 1.5 code)

### Completion Notes List
- All 4 event repository functions implemented and tested successfully
- UUID v4 package installed (uuid@13.0.0 includes native TypeScript types)
- Prisma batch operations used: createMany(), findMany(), deleteMany()
- Test suite validates all 5 Acceptance Criteria with 6 comprehensive tests
- All functions include JSDoc comments and explicit return types per coding standards
- Error handling implemented with try-catch blocks and meaningful error messages
- Test results: 6/6 tests passed (100% success rate)
- Test coverage: Insert 200 events ‚Üí Retrieve ‚Üí Verify order ‚Üí Verify scenarioId ‚Üí Delete ‚Üí Verify empty

### File List
**Created:**
- `lib/data/event-repository.ts` - Event storage functions (generateScenarioId, insertEvents, getEventsByScenario, deleteScenarioEvents)
- `app/api/test-event-storage/route.ts` - Comprehensive test suite validating all AC requirements
- `.eslintrc.json` - ESLint configuration per coding standards

**Modified:**
- `package.json` - Added uuid@13.0.0 and @types/uuid@11.0.0 dependencies

**No files deleted**

## QA Results

### Review Date: 2025-11-17

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** ‚úÖ EXCELLENT

Story 1.5 demonstrates high-quality implementation with comprehensive test coverage, proper error handling, and adherence to all coding standards. The implementation is clean, focused, and production-ready for the PoC phase.

**Strengths:**
- All 4 functions have clear single responsibility
- Comprehensive JSDoc documentation on every export
- Type-safe implementation with proper Prisma types (Decimal, InputJsonValue)
- Excellent error handling with try-catch and meaningful error messages
- Efficient use of Prisma batch operations (createMany, findMany, deleteMany)
- Clean test architecture with 6 comprehensive integration tests
- Proper test cleanup and error recovery

### Refactoring Performed

No refactoring performed. Code quality is excellent as-is.

### Compliance Check

- **Coding Standards:** ‚úÖ PASS
  - TypeScript strict mode enabled with explicit return types
  - JSDoc comments on all exported functions
  - No `any` types (properly uses Prisma-generated types)
  - Proper error handling with try-catch blocks
  - Follows kebab-case naming (event-repository.ts)

- **Project Structure:** ‚úÖ PASS
  - Correct file location: `lib/data/event-repository.ts`
  - Test route at: `app/api/test-event-storage/route.ts`
  - Proper use of `@/` import alias

- **Testing Strategy:** ‚úÖ PASS
  - Manual testing via API route (acceptable for PoC per Story 1.4 precedent)
  - 6 comprehensive tests validating all acceptance criteria
  - Tests include: insert, retrieve, order verification, integrity check, delete, empty state

- **All ACs Met:** ‚úÖ PASS
  - AC1: ‚úÖ `insertEvents()` with Prisma batch insert implemented
  - AC2: ‚úÖ `generateScenarioId()` using UUID v4 implemented
  - AC3: ‚úÖ `getEventsByScenario()` with ordered retrieval implemented
  - AC4: ‚úÖ `deleteScenarioEvents()` for cleanup implemented
  - AC5: ‚úÖ Test demonstrates all functions (6/6 tests passed)

### Requirements Traceability

**AC1 ‚Üí insertEvents() function:**
- **Given:** A scenarioId and array of 200 Event objects
- **When:** insertEvents(scenarioId, events) is called
- **Then:** Returns count of 200 inserted events
- **Test Evidence:** Line 92 of test route - "Test 1 PASSED: Inserted 200 events"

**AC2 ‚Üí generateScenarioId() function:**
- **Given:** No input required
- **When:** generateScenarioId() is called
- **Then:** Returns a valid UUID v4 string
- **Test Evidence:** Line 70 of test route - "Generated scenario ID: [uuid]"

**AC3 ‚Üí getEventsByScenario() function:**
- **Given:** A scenarioId with 200 events in database
- **When:** getEventsByScenario(scenarioId) is called
- **Then:** Returns 200 events ordered by eventDate ascending
- **Test Evidence:** Lines 103, 123 - "Test 2 PASSED: Retrieved 200 events" + "Test 3 PASSED: Events ordered by eventDate (asc)"

**AC4 ‚Üí deleteScenarioEvents() function:**
- **Given:** A scenarioId with 200 events in database
- **When:** deleteScenarioEvents(scenarioId) is called
- **Then:** Returns count of 200 deleted events
- **Test Evidence:** Line 141 - "Test 5 PASSED: Deleted 200 events"

**AC5 ‚Üí Comprehensive test suite:**
- **Given:** Complete test harness with all functions
- **When:** Test suite executes all 6 tests
- **Then:** All tests pass (insert ‚Üí retrieve ‚Üí verify order ‚Üí verify integrity ‚Üí delete ‚Üí verify empty)
- **Test Evidence:** 6/6 tests passed (100% success rate)

‚úÖ **Coverage:** All 5 acceptance criteria have corresponding test validation

### Security Review

**Status:** ‚úÖ PASS - No security concerns

- Server-side only (no client exposure)
- Uses Prisma parameterized queries (SQL injection prevention)
- No user input validation issues (data layer functions)
- Error messages don't expose sensitive internals
- Proper error handling prevents information leakage

### Performance Considerations

**Status:** ‚úÖ PASS - Well-optimized

**Strengths:**
- Uses Prisma batch operations (createMany vs individual inserts)
- Leverages database indexes defined in schema:
  - `scenarioId` index for fast retrieval
  - `eventDate` index for efficient ordering
  - Composite indexes for future dashboard queries
- No N+1 query patterns
- Efficient ordering at database level (not in-memory)

**Test Performance:**
- 200 events inserted/retrieved/deleted in ~2 seconds (acceptable for PoC)

### Reliability Assessment

**Status:** ‚úÖ PASS - Highly reliable

**Error Handling:**
- All async operations wrapped in try-catch
- Meaningful error messages for debugging
- Proper error propagation (throws typed errors)
- Test cleanup on error (lines 175-183 of test route)

**Edge Cases:**
- Empty results return empty array (not error) ‚úì
- Duplicate IDs handled with skipDuplicates ‚úì
- Foreign key constraint handled by test scenario creation ‚úì
- Post-delete verification confirms empty state ‚úì

### Maintainability Assessment

**Status:** ‚úÖ EXCELLENT

**Code Quality:**
- Self-documenting function names
- Comprehensive JSDoc on all exports
- Clean separation of concerns (repository pattern)
- Type-safe with explicit return types
- No magic numbers or unclear logic

**Test Maintainability:**
- Clear test structure with numbered assertions
- Easy to add additional test cases
- Independent test execution (creates own scenario)
- Proper cleanup prevents test pollution

### Technical Debt Identified

**Accepted for PoC (No Action Required):**
- No automated unit tests (manual testing sufficient per PoC strategy)
- No input validation on empty arrays or invalid UUIDs (data layer abstraction)
- Test route is temporary (will be removed post-PoC)

**Future Enhancements (Post-PoC):**
- Consider adding integration tests with test framework (Vitest)
- Add input validation for production hardening
- Consider pagination for large event retrievals (> 10,000 events)

### Improvements Checklist

All items verified as complete:

- [x] Event repository functions implemented (lib/data/event-repository.ts:1-105)
- [x] UUID v4 generation working (line 10)
- [x] Prisma batch operations used (lines 25, 63, 91)
- [x] Type-safe Decimal handling (line 39)
- [x] Comprehensive test suite created (app/api/test-event-storage/route.ts:1-200)
- [x] All 6 tests passing (6/6 = 100%)
- [x] JSDoc documentation complete
- [x] Error handling comprehensive
- [x] TypeScript compiles with 0 errors
- [x] Follows all coding standards

**No outstanding issues or improvements needed.**

### Files Modified During Review

No files modified during QA review. Implementation quality was excellent as submitted.

### Gate Status

**Gate:** ‚úÖ PASS ‚Üí `.bmad-core/qa/gates/1.5-event-storage-scenario-management.yml`

**Quality Score:** 100/100
- Calculation: 100 - (20 √ó 0 FAILs) - (10 √ó 0 CONCERNS) = 100
- All acceptance criteria met
- No security, performance, or reliability concerns
- Excellent code quality and test coverage

### Risk Assessment

**Overall Risk:** üü¢ LOW

| Risk Category | Score | Rationale |
|--------------|-------|-----------|
| Implementation Risk | 1/10 | Simple CRUD operations, well-tested |
| Security Risk | 1/10 | Server-side only, parameterized queries |
| Performance Risk | 2/10 | Batch operations, proper indexes |
| Maintainability Risk | 1/10 | Clean code, good documentation |
| **Total Risk Score** | **1.25/10** | **Very Low Risk** |

### Recommended Status

‚úÖ **Ready for Done**

**Rationale:**
- All 5 acceptance criteria fully implemented and tested
- 6/6 comprehensive tests passing (100% success rate)
- TypeScript compiles with 0 errors
- Follows all coding standards
- No security, performance, or reliability concerns
- Excellent code quality and maintainability
- No outstanding issues or improvements required

**Recommendation:** Story 1.5 is production-ready for PoC phase and ready to be marked as "Done".
