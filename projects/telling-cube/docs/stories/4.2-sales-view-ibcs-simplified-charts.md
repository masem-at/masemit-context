# Story 4.2: Sales View - IBCS© Simplified Charts

## Status
Draft

## Story
**As a** user viewing sales scenario results,
**I want** a simplified, IBCS© compliant sales dashboard with 1 chart and 1 table,
**so that** I can quickly understand sales performance with professional, clear visualizations.

## Acceptance Criteria

1. SalesView component created displaying exactly 1 chart and 1 table (simplified from current multi-chart layout)
2. Chart follows strict IBCS© standards:
   - Variance chart showing AC (Actual), PY (Previous Year), and PL (Plan) comparisons
   - Monochrome color scheme (black/gray bars, red for negative variances, green for positive)
   - Clear axis labels and titles
   - No decorative elements (minimal gridlines, no 3D effects, no shadows)
3. Table follows IBCS© standards:
   - Clean typography (Inter font, sufficient spacing)
   - Inline variance bars in cells (optional but recommended for IBCS© compliance)
   - Clear column headers: Product, AC, PY, ΔPY, PL, ΔPL
   - Right-aligned numbers, left-aligned text
4. Data fetched from existing `/api/scenarios/[id]/sales` endpoint (from Story 2.1)
5. Responsive: chart and table stack vertically on mobile, display optimally on desktop
6. Loading states and error handling implemented (skeleton UI while fetching)

## Tasks / Subtasks

- [ ] Review IBCS© Standards for Charts (AC: 2)
  - [ ] Review IBCS© documentation:
    - SUCCESS formula: SAY, UNIFY, CONDENSE, CHECK, EXPRESS, SIMPLIFY
    - Chart types: Variance charts, column charts, waterfall charts
    - Color usage: Semantic colors only (black/gray for data, red/green for variances)
    - Avoid: Pie charts, 3D effects, decorative colors, excessive gridlines
  - [ ] Reference materials:
    - IBCS© website: https://www.ibcs.com/
    - Book: "International Business Communication Standards" by Rolf Hichert
    - Examples: https://www.ibcs.com/gallery/
  - [ ] Document key principles in dev notes

- [ ] Choose IBCS© Compliant Chart Type (AC: 2)
  - [ ] Evaluate chart types for sales data:
    - **Variance Chart** (AC vs PY, AC vs PL): RECOMMENDED ✅
      - Shows actual performance against comparisons
      - IBCS© compliant pattern
      - Clear visual of over/under performance
    - Column Chart (grouped bars): ACCEPTABLE
      - Shows all three series (AC, PY, PL)
      - Easy to compare
      - Less emphasis on variance
    - Line Chart: NOT RECOMMENDED
      - Better for time series
      - Less impactful for period comparisons
  - [ ] **Decision**: Use Variance Chart (AC vs PY bars, with PL reference line)

- [ ] Install IBCS© Compliant Charting Library (AC: 2)
  - [ ] Evaluate charting libraries:
    - **Recharts** (CURRENT, used in Epic 2):
      - Pros: Already installed, React-native, customizable
      - Cons: Requires manual IBCS© styling
      - Decision: KEEP and customize for IBCS© compliance
    - Victory: More opinionated, heavier bundle
    - Chart.js: Not React-native
    - D3.js: Too low-level for MVP
  - [ ] Verify recharts is installed: `pnpm list recharts`
  - [ ] If not: `pnpm add recharts`

- [ ] Create IBCS© Variance Chart Component (AC: 2, 5)
  - [ ] Create `components/charts/IBCSVarianceChart.tsx`:
    ```tsx
    'use client'

    import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine } from 'recharts'

    interface VarianceChartData {
      category: string // e.g., "Product A"
      actual: number
      previousYear: number
      plan: number
      variancePY: number // actual - previousYear
      variancePL: number // actual - plan
    }

    interface IBCSVarianceChartProps {
      data: VarianceChartData[]
      title: string
      height?: number
    }

    export function IBCSVarianceChart({ data, title, height = 400 }: IBCSVarianceChartProps) {
      return (
        <div className="bg-white rounded-lg border border-gray-200 p-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">{title}</h3>
          <ResponsiveContainer width="100%" height={height}>
            <BarChart
              data={data}
              margin={{ top: 20, right: 30, left: 20, bottom: 60 }}
            >
              {/* Minimal gridlines (IBCS© principle: reduce visual noise) */}
              <CartesianGrid strokeDasharray="3 3" stroke="#E5E7EB" vertical={false} />

              {/* Clear axis labels */}
              <XAxis
                dataKey="category"
                angle={-45}
                textAnchor="end"
                height={80}
                tick={{ fill: '#374151', fontSize: 12 }}
              />
              <YAxis
                tick={{ fill: '#374151', fontSize: 12 }}
                axisLine={{ stroke: '#9CA3AF' }}
              />

              {/* Zero reference line (IBCS© best practice) */}
              <ReferenceLine y={0} stroke="#000" strokeWidth={1} />

              {/* Tooltip with clear formatting */}
              <Tooltip
                contentStyle={{
                  backgroundColor: 'white',
                  border: '1px solid #E5E7EB',
                  borderRadius: '8px',
                }}
                formatter={(value: number) => value.toLocaleString()}
              />

              {/* Legend with clear labels */}
              <Legend
                wrapperStyle={{ paddingTop: '20px' }}
                iconType="rect"
              />

              {/* IBCS© color scheme: Gray for actual, light gray for comparisons */}
              <Bar dataKey="actual" fill="#374151" name="Actual (AC)" />
              <Bar dataKey="previousYear" fill="#9CA3AF" name="Previous Year (PY)" />
              <Bar dataKey="plan" fill="#D1D5DB" name="Plan (PL)" />
            </BarChart>
          </ResponsiveContainer>
        </div>
      )
    }
    ```
  - [ ] Apply IBCS© principles:
    - Monochrome colors (grays, not rainbow)
    - Minimal gridlines (horizontal only)
    - Clear labels and units
    - No decorative elements
    - Zero baseline visible

- [ ] Create IBCS© Compliant Table Component (AC: 3, 5)
  - [ ] Create `components/charts/IBCSTable.tsx`:
    ```tsx
    'use client'

    interface TableRow {
      product: string
      actual: number
      previousYear: number
      variancePY: number
      plan: number
      variancePL: number
    }

    interface IBCSTableProps {
      data: TableRow[]
      title: string
    }

    export function IBCSTable({ data, title }: IBCSTableProps) {
      const formatNumber = (num: number) => num.toLocaleString()
      const formatVariance = (num: number) => {
        const sign = num >= 0 ? '+' : ''
        return `${sign}${num.toLocaleString()}`
      }

      return (
        <div className="bg-white rounded-lg border border-gray-200 p-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">{title}</h3>
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead>
                <tr className="bg-gray-50">
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                    Product
                  </th>
                  <th className="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">
                    AC
                  </th>
                  <th className="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">
                    PY
                  </th>
                  <th className="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">
                    ΔPY
                  </th>
                  <th className="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">
                    PL
                  </th>
                  <th className="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">
                    ΔPL
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-100">
                {data.map((row, idx) => (
                  <tr key={idx} className="hover:bg-gray-50 transition-colors">
                    <td className="px-4 py-3 text-sm text-gray-900 font-medium">
                      {row.product}
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-900 text-right font-mono">
                      {formatNumber(row.actual)}
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-600 text-right font-mono">
                      {formatNumber(row.previousYear)}
                    </td>
                    <td className={`px-4 py-3 text-sm text-right font-mono font-semibold ${
                      row.variancePY >= 0 ? 'text-green-700' : 'text-red-700'
                    }`}>
                      {formatVariance(row.variancePY)}
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-600 text-right font-mono">
                      {formatNumber(row.plan)}
                    </td>
                    <td className={`px-4 py-3 text-sm text-right font-mono font-semibold ${
                      row.variancePL >= 0 ? 'text-green-700' : 'text-red-700'
                    }`}>
                      {formatVariance(row.variancePL)}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )
    }
    ```
  - [ ] Apply IBCS© table principles:
    - Right-align numbers (easier to compare)
    - Left-align text (product names)
    - Monospaced font for numbers (font-mono)
    - Clear headers with standard abbreviations (AC, PY, PL, Δ)
    - Semantic colors for variances (green positive, red negative)
    - Sufficient spacing for readability

- [ ] Create SalesView Component (AC: 1, 4, 5, 6)
  - [ ] Create `components/results/SalesView.tsx`:
    ```tsx
    'use client'

    import { useEffect, useState } from 'react'
    import { IBCSVarianceChart } from '@/components/charts/IBCSVarianceChart'
    import { IBCSTable } from '@/components/charts/IBCSTable'

    interface SalesViewProps {
      scenarioId: string
    }

    export function SalesView({ scenarioId }: SalesViewProps) {
      const [data, setData] = useState(null)
      const [loading, setLoading] = useState(true)
      const [error, setError] = useState<string | null>(null)

      useEffect(() => {
        const fetchSalesData = async () => {
          try {
            setLoading(true)
            const response = await fetch(`/api/scenarios/${scenarioId}/sales`)

            if (!response.ok) {
              throw new Error('Failed to fetch sales data')
            }

            const result = await response.json()
            setData(result)
          } catch (err) {
            setError(err instanceof Error ? err.message : 'Unknown error')
          } finally {
            setLoading(false)
          }
        }

        fetchSalesData()
      }, [scenarioId])

      if (loading) {
        return (
          <div className="space-y-6">
            {/* Skeleton UI */}
            <div className="bg-gray-100 rounded-lg h-96 animate-pulse" />
            <div className="bg-gray-100 rounded-lg h-64 animate-pulse" />
          </div>
        )
      }

      if (error) {
        return (
          <div className="bg-red-50 border border-red-200 rounded-lg p-6">
            <p className="text-red-800 font-semibold">Error loading sales data</p>
            <p className="text-red-700">{error}</p>
          </div>
        )
      }

      if (!data) {
        return null
      }

      // Transform API data to chart format
      const chartData = transformToChartData(data)
      const tableData = transformToTableData(data)

      return (
        <div className="space-y-8">
          {/* Single IBCS© Chart */}
          <IBCSVarianceChart
            data={chartData}
            title="Sales Performance by Product (AC vs PY vs PL)"
          />

          {/* Single IBCS© Table */}
          <IBCSTable
            data={tableData}
            title="Sales Data Overview"
          />
        </div>
      )
    }

    function transformToChartData(apiData: any) {
      // Transform API response to chart format
      // Implementation depends on API structure from Story 2.1
      return apiData.productSales.map((item: any) => ({
        category: item.productName,
        actual: item.actualSales,
        previousYear: item.previousYearSales,
        plan: item.plannedSales,
        variancePY: item.actualSales - item.previousYearSales,
        variancePL: item.actualSales - item.plannedSales,
      }))
    }

    function transformToTableData(apiData: any) {
      // Transform API response to table format
      return apiData.productSales.map((item: any) => ({
        product: item.productName,
        actual: item.actualSales,
        previousYear: item.previousYearSales,
        variancePY: item.actualSales - item.previousYearSales,
        plan: item.plannedSales,
        variancePL: item.actualSales - item.plannedSales,
      }))
    }
    ```
  - [ ] Verify `/api/scenarios/[id]/sales` endpoint exists (from Story 2.1)
  - [ ] Test data transformation logic with real API response

- [ ] Responsive Design (AC: 5)
  - [ ] Apply responsive classes:
    - Chart container: `w-full` (full width on all screens)
    - Chart height: Reduce on mobile (300px) vs desktop (400px)
    - Table: Horizontal scroll on mobile (`overflow-x-auto`)
    - Stack chart and table vertically with spacing (`space-y-8`)
  - [ ] Test on mobile viewport (375px width)
  - [ ] Test on tablet viewport (768px width)
  - [ ] Test on desktop viewport (1440px width)

- [ ] Loading States & Error Handling (AC: 6)
  - [ ] Implement skeleton UI:
    - Gray boxes with pulse animation
    - Match approximate size of final chart/table
    - Use Tailwind animate-pulse utility
  - [ ] Implement error state:
    - Red background alert box
    - Clear error message
    - Optional "Retry" button
  - [ ] Test error scenarios:
    - Network failure
    - Invalid scenarioId
    - API returns 500 error

- [ ] Integration with Story 4.1 Navigation (Integration Test)
  - [ ] Verify SalesView renders in ViewNavigation context
  - [ ] Test view switching: Sales → Finance → Sales
  - [ ] Verify no memory leaks (cleanup useEffect on unmount)
  - [ ] Test with multiple scenarios

- [ ] IBCS© Design Review & Polish (AC: 2, 3)
  - [ ] Chart review checklist:
    - [ ] Monochrome color scheme (no rainbow colors) ✅
    - [ ] Minimal gridlines (horizontal only) ✅
    - [ ] Clear axis labels (no abbreviations unless standard) ✅
    - [ ] Zero baseline visible ✅
    - [ ] No 3D effects, shadows, or decorations ✅
    - [ ] Sufficient white space ✅
  - [ ] Table review checklist:
    - [ ] Right-aligned numbers ✅
    - [ ] Left-aligned text ✅
    - [ ] Clear column headers (AC, PY, ΔPY, PL, ΔPL) ✅
    - [ ] Semantic color for variances (green/red) ✅
    - [ ] Sufficient row spacing ✅
    - [ ] Monospaced numbers for alignment ✅
  - [ ] Get feedback from UX expert (Sally) or user (Mario)

- [ ] Testing & Validation
  - [ ] Manual testing:
    - [ ] Generate scenario and navigate to Sales View
    - [ ] Verify chart displays with correct data
    - [ ] Verify table displays with correct data
    - [ ] Test responsive behavior (resize browser)
    - [ ] Test loading state (slow network simulation)
    - [ ] Test error state (disconnect network)
  - [ ] Visual regression testing:
    - [ ] Take screenshot for future comparison
    - [ ] Verify IBCS© compliance visually
  - [ ] Run `pnpm lint` and `pnpm build`

## Dev Notes

### IBCS© Standards Overview
[Source: IBCS.com, "International Business Communication Standards"]

**SUCCESS Formula:**
1. **SAY**: Clear message (what does the chart say?)
2. **UNIFY**: Consistent notation (same colors, same labels across charts)
3. **CONDENSE**: Maximize data-ink ratio (remove unnecessary elements)
4. **CHECK**: Ensure visual integrity (no misleading scales)
5. **EXPRESS**: Choose right chart type (variance, time series, structure, etc.)
6. **SIMPLIFY**: Avoid clutter (minimal gridlines, no decorations)

**Key Visual Principles:**
- **Semantic Colors Only**: Black/gray for data, red for negative, green for positive
- **No Decorative Colors**: Avoid blue, orange, purple just for aesthetics
- **Minimal Gridlines**: Horizontal only (aid reading values), no vertical
- **Clear Typography**: Professional fonts (Inter), sufficient size (12px+)
- **Zero Baseline**: Always show zero reference for bar charts
- **Avoid**: Pie charts, 3D effects, shadows, gradients, background images

### Chart Type Decision: Variance Chart
[Source: IBCS© chart type recommendations]

**Why Variance Chart:**
- **Primary Goal**: Show performance against comparisons (AC vs PY, AC vs PL)
- **IBCS© Recommended**: Standard pattern for business reporting
- **Clear Visual**: Bars above/below zero line = over/under performance
- **Supports Analysis**: Easy to see which products exceeded plan/previous year

**Alternative Considered: Grouped Column Chart**
- Shows AC, PY, PL as separate bars
- Good for absolute value comparison
- Less emphasis on variance (requires mental math)
- Still IBCS© compliant but less impactful

### Color Palette: IBCS© Monochrome
[Source: IBCS© semantic color rules]

**Chart Colors:**
- Actual (AC): Dark gray (#374151 / gray-700) - PRIMARY data
- Previous Year (PY): Medium gray (#9CA3AF / gray-400) - COMPARISON
- Plan (PL): Light gray (#D1D5DB / gray-300) - COMPARISON
- Positive variance: Green (#15803D / green-700) - SEMANTIC
- Negative variance: Red (#B91C1C / red-700) - SEMANTIC

**Why Not Use Brand Blue (#2563EB):**
- IBCS© reserves colors for semantic meaning (good/bad, actual/plan)
- Blue has no inherent business meaning
- Monochrome ensures professional, data-focused appearance

**Exception: Small accents**
- Can use blue for interactive elements (hover states, buttons)
- Never for data representation

### Table Design: Right-Aligned Numbers
[Source: IBCS© table formatting rules]

**Why Right-Align Numbers:**
- Easier to compare magnitudes (digit place values align)
- Industry standard for financial tables
- Works with monospaced fonts for perfect alignment

**Example:**
```
Product       AC      PY     ΔPY
Product A  1,234     987    +247  ← Ones place aligns
Product B 12,345  11,234  +1,111  ← All digits align
```

**Column Headers:**
- **AC**: Actual (current period)
- **PY**: Previous Year (comparison)
- **ΔPY**: Delta Previous Year (variance = AC - PY)
- **PL**: Plan (budget/forecast)
- **ΔPL**: Delta Plan (variance = AC - PL)

### Data Transformation Logic
[Source: Story 2.1 API structure]

**API Response Format** (from Story 2.1):
```typescript
{
  scenarioId: string,
  productSales: [
    {
      productName: string,
      actualSales: number,
      previousYearSales: number,
      plannedSales: number,
    },
    ...
  ]
}
```

**Chart Data Format** (required by Recharts):
```typescript
{
  category: string,      // productName
  actual: number,        // actualSales
  previousYear: number,  // previousYearSales
  plan: number,          // plannedSales
  variancePY: number,    // actual - previousYear
  variancePL: number,    // actual - plan
}
```

**Transformation Function:**
```typescript
function transformToChartData(apiData: any) {
  return apiData.productSales.map((item: any) => ({
    category: item.productName,
    actual: item.actualSales,
    previousYear: item.previousYearSales,
    plan: item.plannedSales,
    variancePY: item.actualSales - item.previousYearSales,
    variancePL: item.actualSales - item.plannedSales,
  }))
}
```

### Responsive Strategy
[Source: Mobile-first design principles]

**Breakpoints:**
- Mobile (<640px): Stack chart/table, reduce chart height, horizontal scroll table
- Tablet (640px-1024px): Stack chart/table, full chart height, horizontal scroll table
- Desktop (>1024px): Stack chart/table, full chart height, table fits width

**Chart Height:**
- Mobile: 300px (less vertical space available)
- Desktop: 400px (more room for data)

**Table Overflow:**
- Always use `overflow-x-auto` (horizontal scroll if needed)
- Never hide columns on mobile (users can scroll)
- Sticky first column (optional enhancement)

### Loading State Pattern
[Source: Epic 2 patterns, Story 3.2 loading page]

**Why Skeleton UI:**
- Better UX than spinner (shows layout preview)
- Reduces perceived loading time
- Matches final content size (no layout shift)

**Implementation:**
```tsx
{loading && (
  <div className="space-y-6">
    <div className="bg-gray-100 rounded-lg h-96 animate-pulse" />
    <div className="bg-gray-100 rounded-lg h-64 animate-pulse" />
  </div>
)}
```

**Tailwind animate-pulse:**
- Built-in utility (no custom CSS)
- Smooth fade in/out animation
- Professional appearance

### Error Handling Strategy
[Source: Story 3.9 error handling patterns]

**Error States to Handle:**
1. **Network error**: `fetch()` throws exception
2. **API error**: Response status 4xx/5xx
3. **Invalid data**: Missing required fields
4. **Timeout**: Request takes too long

**Error Display:**
```tsx
{error && (
  <div className="bg-red-50 border border-red-200 rounded-lg p-6">
    <p className="text-red-800 font-semibold">Error loading sales data</p>
    <p className="text-red-700">{error}</p>
  </div>
)}
```

**User Actions:**
- Show clear error message
- Optionally provide "Retry" button
- Log error to console (for debugging)
- Don't expose internal error details

### Integration with Story 2.1 API
[Source: Story 2.1 - Sales View Data Layer & API]

**Endpoint:** `GET /api/scenarios/[id]/sales`

**Expected Response:**
```json
{
  "scenarioId": "abc123",
  "scenarioType": "bakery",
  "productSales": [
    {
      "productName": "Sourdough Bread",
      "actualSales": 12500,
      "previousYearSales": 11000,
      "plannedSales": 13000
    },
    ...
  ],
  "totalSales": {
    "actual": 125000,
    "previousYear": 110000,
    "plan": 130000
  }
}
```

**Usage in SalesView:**
- Fetch on component mount
- Transform to chart/table format
- Display in IBCS© components

### Simplified from Epic 2
[Source: Epic 2 results page, Story 2.3]

**Epic 2 Sales View (OLD):**
- 3-4 charts (sales by product, sales over time, top products, regional sales)
- Complex layout with multiple tabs
- Many color schemes

**Epic 4 Sales View (NEW - THIS STORY):**
- **1 chart**: Variance chart (AC vs PY vs PL by product)
- **1 table**: Sales data overview with variances
- Strict IBCS© compliance
- Monochrome color scheme
- Maximum clarity and focus

**Why Simplify:**
- IBCS© principle: CONDENSE (show only essential data)
- Faster to implement (MVP focus)
- Easier to understand (clear message)
- Professional appearance (less visual noise)

### Future Enhancements
[Source: Post-MVP planning]

**Potential Additions:**
- Time series chart (sales trend over 12 months)
- Regional breakdown chart (if multi-location scenarios added)
- Inline sparklines in table (mini trend charts in cells)
- Export to Excel functionality
- Print-friendly view
- Drill-down to transaction details

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-19 | 1.0 | Initial story draft for Epic 4 | Bob (Scrum Master) |
