# Story 1.3: Claude API Integration & Test

## Status
Done

## Story
**As a** developer,
**I want** Claude API integrated with proper error handling and retry logic,
**so that** I can reliably call the AI generation service for scenario creation.

## Acceptance Criteria
1. `@anthropic-ai/sdk` installed and configured with API key from environment variable `ANTHROPIC_API_KEY`
2. Utility function `lib/ai/claude-client.ts` created that accepts prompt and returns Claude response with TypeScript types
3. Test API route (`/api/test-claude`) sends simple prompt ("Generate a list of 3 business events") and returns Claude's response
4. Error handling implemented for API failures (network errors, rate limits, invalid API key) with user-friendly error messages
5. Circuit breaker pattern implemented: after 3 consecutive failures, stop retrying and return error (prevents runaway API costs)

## Tasks / Subtasks

- [x] Install Anthropic SDK dependency (AC: 1)
  - [x] Run `pnpm add @anthropic-ai/sdk`
  - [x] Verify package added to package.json dependencies

- [x] Configure environment variable for Anthropic API key (AC: 1)
  - [x] Add `ANTHROPIC_API_KEY="sk-ant-xxx"` to `.env.local`
  - [x] Update `.env.local.example` with Anthropic API key template
  - [x] Verify `.env.local` is in `.gitignore` (already done in Story 1.2)

- [x] Create Claude client utility with TypeScript types (AC: 2)
  - [x] Create file `lib/ai/claude-client.ts`
  - [x] Import `Anthropic` from `@anthropic-ai/sdk`
  - [x] Initialize Anthropic client with `apiKey: process.env.ANTHROPIC_API_KEY`
  - [x] Create `sendPrompt(prompt: string)` function that calls Claude 3.5 Sonnet
  - [x] Set model to `claude-3-5-sonnet-20241022` (latest Claude 3.5 Sonnet)
  - [x] Set temperature to 0.7, max_tokens to 4096
  - [x] Return typed response with `{ content: string, usage: { input_tokens: number, output_tokens: number } }`

- [x] Implement error handling for Claude API (AC: 4)
  - [x] Wrap API call in try-catch block
  - [x] Check for missing `ANTHROPIC_API_KEY` and throw descriptive error
  - [x] Handle `AnthropicError` with user-friendly message mapping:
    - Rate limit errors (429) → "AI service is busy, please try again"
    - Invalid API key (401) → "API key configuration error"
    - Network errors → "Failed to connect to AI service"
  - [x] Return error response with `{ error: string, details?: string }` format

- [x] Implement circuit breaker pattern (AC: 5)
  - [x] Create state tracker for consecutive failures (in-memory counter)
  - [x] Increment counter on each API failure
  - [x] Reset counter to 0 on successful API call
  - [x] After 3 consecutive failures, throw error: "Circuit breaker open: too many API failures"
  - [x] Log circuit breaker state changes to console

- [x] Create test API route (AC: 3)
  - [x] Create file `app/api/test-claude/route.ts`
  - [x] Import `sendPrompt` from `lib/ai/claude-client.ts`
  - [x] Create POST handler
  - [x] Call `sendPrompt("Generate a list of 3 business events in JSON format with fields: eventType, amount, date")`
  - [x] Return JSON response: `{ success: true, response: string, usage: { ... } }`
  - [x] Handle errors and return `{ success: false, error: string }`

- [x] Manual testing and verification (AC: 3, 4, 5)
  - [x] Test with valid API key: `curl -X POST http://localhost:3003/api/test-claude`
  - [x] Verify response contains 3 business events
  - [x] Test with invalid API key (temporarily break ANTHROPIC_API_KEY)
  - [x] Verify error message is user-friendly
  - [x] Test circuit breaker by triggering 3 consecutive failures
  - [x] Verify circuit breaker opens after 3 failures

## Dev Notes

### Claude API Integration Architecture

**Purpose:** This story establishes the foundation for AI-powered scenario generation by integrating the Anthropic Claude API with proper error handling and cost protection.

[Source: architecture.md#Service 1: Generation Service]

### API Configuration

**Model Selection:** Claude 3.5 Sonnet (`claude-3-5-sonnet-20241022`)

**Rationale:**
- Best balance of quality and cost: $3/$15 per 1M tokens
- Average scenario cost: ~$0.165 (vs OpenAI $0.45)
- 200K context window (handles large prompts)
- Excellent JSON output (critical for structured event data)

[Source: architecture.md#Platform and Infrastructure Choice]

**Temperature Settings:**
- For this test story: Use 0.7 (balanced creativity)
- Future stories will use:
  - 0.7 for master data generation (needs variety)
  - 0.5 for event generation (needs consistency)

[Source: architecture.md#Service 1: Generation Service]

### Environment Variables

**File:** `.env.local`

Add the following variable:
```bash
# AI Generation
ANTHROPIC_API_KEY="sk-ant-xxx"
```

**Security Notes:**
- `.env.local` is already in `.gitignore` (verified in Story 1.2)
- Never commit API keys to Git
- Use placeholder `sk-ant-xxx` in `.env.local.example`

[Source: architecture.md#Environment Variables]

### File Structure

**New Files to Create:**
```
/telling-cube
├── /lib
│   └── /ai
│       └── claude-client.ts    # Claude API client utility
├── /app/api
│   └── /test-claude
│       └── route.ts             # Test API route
└── .env.local                   # Updated with ANTHROPIC_API_KEY
```

[Source: architecture.md#Repository Structure]

### Claude Client Implementation Pattern

**File:** `lib/ai/claude-client.ts`

**Key Requirements:**
- Initialize Anthropic client once (singleton pattern)
- Export async function `sendPrompt(prompt: string)`
- Return typed response matching TypeScript interface
- Handle all error types gracefully

**Error Types to Handle:**
1. **Missing API Key:** `if (!process.env.ANTHROPIC_API_KEY)`
2. **Network Errors:** Connection failures, timeouts
3. **API Errors:** Rate limits (429), Invalid key (401), Server errors (500)
4. **Circuit Breaker:** After 3 consecutive failures

[Source: architecture.md#Backend Architecture]

### Error Handling Pattern

**User-Friendly Error Messages:**

Map technical errors to clear messages:
- `AnthropicError` with status 429 → "AI service is busy, please try again in a few moments"
- `AnthropicError` with status 401 → "API key configuration error. Please check your environment variables"
- Network errors → "Failed to connect to AI service. Please check your internet connection"
- Circuit breaker open → "AI service temporarily unavailable due to repeated failures. Please try again later"

**Error Response Format:**
```typescript
{
  error: string          // User-friendly message
  details?: string       // Technical details (optional, for debugging)
}
```

[Source: architecture.md#Error Handling]

### Circuit Breaker Pattern

**Purpose:** Prevent runaway API costs if Claude API fails repeatedly

**Implementation:**
- Track consecutive failures in memory (simple counter)
- Reset counter on successful call
- After 3 failures: Stop calling API, return error immediately
- Log state changes: "Circuit breaker: failure 1/3", "Circuit breaker OPEN"

**Why 3 failures?**
- Balances protection vs. usability
- Allows for transient network issues (1-2 retries)
- Prevents cascading costs (stops before significant charges)

[Source: architecture.md#Architectural Patterns]

### API Response Structure

**Claude API Response (from @anthropic-ai/sdk):**
```typescript
{
  content: [{
    type: 'text',
    text: string
  }],
  usage: {
    input_tokens: number,
    output_tokens: number
  }
}
```

**Our Wrapper Response:**
```typescript
{
  content: string           // Extracted text content
  usage: {
    input_tokens: number,
    output_tokens: number
  }
}
```

[Source: @anthropic-ai/sdk TypeScript types]

### Test API Route

**Purpose:** Validate Claude API integration works end-to-end

**Test Prompt:**
"Generate a list of 3 business events in JSON format with fields: eventType, amount, date. Keep it simple."

**Expected Response:**
```json
{
  "success": true,
  "response": "[{\"eventType\":\"sales_transaction\",\"amount\":150,\"date\":\"2024-01-15\"}...]",
  "usage": {
    "input_tokens": 45,
    "output_tokens": 120
  }
}
```

**Manual Test Command:**
```bash
curl -X POST http://localhost:3003/api/test-claude
```

[Source: PRD Story 1.3 AC#3]

### TypeScript Type Definitions

**File:** `lib/ai/claude-client.ts`

```typescript
export interface ClaudeResponse {
  content: string
  usage: {
    input_tokens: number
    output_tokens: number
  }
}

export interface ClaudeErrorResponse {
  error: string
  details?: string
}
```

### Cost Tracking

**Estimated Test Costs:**
- Test prompt input: ~40 tokens ($0.00012)
- Test prompt output: ~100 tokens ($0.0015)
- **Total per test call: ~$0.00162**

For 10 test calls during development: **~$0.016 total**

[Source: architecture.md#Service 1: Generation Service - Cost calculation]

### Previous Story Context

**From Story 1.2 (Database Schema):**
- `.env.local` file exists and is gitignored
- Prisma client singleton pattern established in `lib/db.ts`
- Test API route pattern established at `/app/api/test-db/route.ts`

**Lessons Learned:**
- Use Next.js App Router API route pattern (POST handler export)
- Use singleton pattern for external service clients (prevents multiple instances)
- Test routes should return `{ success: boolean, ... }` format

[Source: docs/stories/1.2-database-schema-connection.md]

### Testing

**Testing Strategy:** Manual testing only (no automated tests for MVP)

**Manual Test Checklist:**
1. ✅ Verify package installed: `@anthropic-ai/sdk` in package.json
2. ✅ Verify ANTHROPIC_API_KEY in `.env.local`
3. ✅ Test valid API call: Returns 3 business events
4. ✅ Test invalid API key: Returns user-friendly error
5. ✅ Test circuit breaker: Fails after 3 consecutive errors
6. ✅ Verify token usage logged in response

**No unit tests required for Story 1.3** (infrastructure setup story - tested via manual verification and test API route)

[Source: architecture.md#Testing Strategy - Manual testing for PoC phase]

### Design Rationale

**Why Circuit Breaker?**
- Protects against runaway costs if API fails
- MVP priority is cost control over resilience
- Simple in-memory counter sufficient for single-instance deployment

**Why Test Route?**
- Validates end-to-end integration
- Provides debugging endpoint for future stories
- Can be removed post-PoC (not user-facing)

**Why @anthropic-ai/sdk over raw HTTP?**
- Official SDK handles authentication, retries, timeouts
- TypeScript types included
- Better error handling out of the box

[Source: architecture.md#Backend Architecture]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-16 | 1.0 | Initial story creation from PRD Epic 1, Story 1.3 | Bob (SM) |
| 2025-11-16 | 1.1 | Story approved for development | Sarah (PO) |
| 2025-11-16 | 1.2 | Story completed - Claude API integration with claude-3-haiku-20240307, all tests passing | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- Package installation: `@anthropic-ai/sdk` v0.69.0 installed successfully
- Model compatibility testing: Tested multiple model identifiers before finding compatible model
- Manual testing performed on http://localhost:3004/api/test-claude

### Completion Notes List

**Implementation Summary:**
All acceptance criteria met successfully with one notable deviation from original specification.

**Model Selection Deviation:**
- Original spec called for `claude-3-5-sonnet-20241022` (Claude 3.5 Sonnet)
- API key has limited model access - only Claude 3 Haiku available
- Implemented with `claude-3-haiku-20240307` instead
- All other requirements met exactly as specified

**Testing Results:**
1. Valid API key test: PASS - Returns 3 business events with eventType, amount, date fields
2. Invalid API key test: PASS - Returns user-friendly error: "API key configuration error. Please check your environment variables"
3. Circuit breaker test: PASS - Opens after 3 consecutive failures with message: "Circuit breaker open: too many API failures. Please try again later."
4. Token usage tracking: PASS - Response includes input_tokens and output_tokens
5. Circuit breaker reset: PASS - Resets on server restart

**Technical Implementation:**
- Singleton pattern for Anthropic client (prevents multiple instances)
- In-memory circuit breaker with 3-failure threshold
- Comprehensive error handling for 401, 429, and network errors
- TypeScript interfaces: ClaudeResponse, ClaudeErrorResponse
- Next.js App Router API route pattern

**Files Created:**
- `lib/ai/claude-client.ts` (97 lines)
- `app/api/test-claude/route.ts` (24 lines)

**Dependencies Added:**
- `@anthropic-ai/sdk` ^0.69.0

**Environment Variables:**
- ANTHROPIC_API_KEY verified in .env.local
- .env.local.example already configured (from Story 1.2)

### File List
1. `lib/ai/claude-client.ts` - Claude API client with circuit breaker and error handling
2. `app/api/test-claude/route.ts` - Test API route for validating integration
3. `package.json` - Updated with @anthropic-ai/sdk dependency
4. `.env.local` - Contains ANTHROPIC_API_KEY (not committed)
5. `.env.local.example` - Template with API key placeholder (already existed)

## QA Results
_To be populated by QA agent_
