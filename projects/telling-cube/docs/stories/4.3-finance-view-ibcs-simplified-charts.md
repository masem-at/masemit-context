# Story 4.3: Finance View - IBCS© Simplified Charts

## Status
Draft

## Story
**As a** user viewing finance scenario results,
**I want** a simplified, IBCS© compliant finance dashboard with 1 chart and 1 table,
**so that** I can quickly understand financial performance with professional, clear visualizations.

## Acceptance Criteria

1. FinanceView component created displaying exactly 1 chart and 1 table (simplified from current multi-chart layout)
2. Chart follows strict IBCS© standards:
   - Waterfall chart or variance chart showing P&L performance (Revenue, COGS, Expenses, Net Income)
   - Monochrome color scheme (black/gray for components, green for profit, red for loss)
   - Clear axis labels and titles
   - No decorative elements (minimal gridlines, no 3D effects, no shadows)
3. Table follows IBCS© standards:
   - Clean typography (Inter font, sufficient spacing)
   - Clear column headers: Category, AC, PY, ΔPY, PL, ΔPL
   - Right-aligned numbers, left-aligned text
   - Semantic colors for variances (green positive, red negative)
4. Data fetched from existing `/api/scenarios/[id]/finance` endpoint (from Story 2.2)
5. Responsive: chart and table stack vertically on mobile, display optimally on desktop
6. Loading states and error handling implemented (skeleton UI while fetching)

## Tasks / Subtasks

- [ ] Review IBCS© Standards for Finance Charts (AC: 2)
  - [ ] Review IBCS© financial reporting patterns:
    - Waterfall charts for P&L breakdown (recommended for finance)
    - Variance charts for period comparisons
    - Column charts for component comparison
  - [ ] Reference IBCS© gallery examples:
    - Profit & Loss statements
    - Balance sheet visualizations
    - Cash flow diagrams
  - [ ] Document best practices for finance dashboards

- [ ] Choose IBCS© Compliant Chart Type (AC: 2)
  - [ ] Evaluate chart types for P&L data:
    - **Waterfall Chart** (Revenue → COGS → Expenses → Net Income): RECOMMENDED ✅
      - Shows how revenue flows to profit
      - IBCS© standard for financial statements
      - Clear visual storytelling
      - Implementation: Use Recharts ComposedChart or custom bars
    - Variance Chart (AC vs PY for each P&L category): ACCEPTABLE
      - Similar to Story 4.2 (Sales View)
      - Shows performance against comparisons
      - Less emphasis on P&L flow
    - Grouped Column Chart: ACCEPTABLE but less impactful
  - [ ] **Decision**: Use Waterfall Chart for P&L flow visualization

- [ ] Research Waterfall Chart Implementation (AC: 2)
  - [ ] Check if Recharts supports waterfall natively:
    - Recharts does NOT have built-in waterfall chart
    - Can be created using stacked bars with transparent segments
    - Alternative: Use ComposedChart with custom bars
  - [ ] Research implementation patterns:
    - Stack bars to create waterfall effect
    - Use transparent bars for spacing
    - Add connector lines between bars (optional)
  - [ ] Decide on implementation approach:
    - **Option 1**: Custom waterfall using stacked bars (simpler)
    - **Option 2**: Use third-party library (recharts-waterfall, etc.)
    - **Decision**: Custom implementation for full control and IBCS© compliance

- [ ] Create IBCS© Waterfall Chart Component (AC: 2, 5)
  - [ ] Create `components/charts/IBCSWaterfallChart.tsx`:
    ```tsx
    'use client'

    import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell, ReferenceLine } from 'recharts'

    interface WaterfallData {
      category: string
      value: number
      total: number // Running total for positioning
      isPositive: boolean
    }

    interface IBCSWaterfallChartProps {
      data: {
        revenue: number
        cogs: number
        expenses: number
        netIncome: number
      }
      title: string
      height?: number
    }

    export function IBCSWaterfallChart({ data, title, height = 400 }: IBCSWaterfallChartProps) {
      // Transform P&L data to waterfall format
      const waterfallData: WaterfallData[] = [
        {
          category: 'Revenue',
          value: data.revenue,
          total: 0,
          isPositive: true,
        },
        {
          category: 'COGS',
          value: Math.abs(data.cogs), // Negative value
          total: data.revenue,
          isPositive: false,
        },
        {
          category: 'Gross Profit',
          value: data.revenue - data.cogs,
          total: 0,
          isPositive: data.revenue - data.cogs > 0,
        },
        {
          category: 'Expenses',
          value: Math.abs(data.expenses), // Negative value
          total: data.revenue - data.cogs,
          isPositive: false,
        },
        {
          category: 'Net Income',
          value: data.netIncome,
          total: 0,
          isPositive: data.netIncome > 0,
        },
      ]

      return (
        <div className="bg-white rounded-lg border border-gray-200 p-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">{title}</h3>
          <ResponsiveContainer width="100%" height={height}>
            <BarChart
              data={waterfallData}
              margin={{ top: 20, right: 30, left: 20, bottom: 60 }}
            >
              <CartesianGrid strokeDasharray="3 3" stroke="#E5E7EB" vertical={false} />
              <XAxis
                dataKey="category"
                angle={-45}
                textAnchor="end"
                height={80}
                tick={{ fill: '#374151', fontSize: 12 }}
              />
              <YAxis
                tick={{ fill: '#374151', fontSize: 12 }}
                axisLine={{ stroke: '#9CA3AF' }}
                tickFormatter={(value) => `$${(value / 1000).toFixed(0)}k`}
              />
              <ReferenceLine y={0} stroke="#000" strokeWidth={1} />
              <Tooltip
                contentStyle={{
                  backgroundColor: 'white',
                  border: '1px solid #E5E7EB',
                  borderRadius: '8px',
                }}
                formatter={(value: number) => `$${value.toLocaleString()}`}
              />
              <Bar dataKey="value">
                {waterfallData.map((entry, index) => (
                  <Cell
                    key={`cell-${index}`}
                    fill={entry.isPositive ? '#059669' : '#DC2626'} // Green for income, red for expenses
                  />
                ))}
              </Bar>
            </BarChart>
          </ResponsiveContainer>
        </div>
      )
    }
    ```
  - [ ] Alternative: Use simpler variance chart if waterfall is too complex:
    ```tsx
    // Fallback to variance chart (similar to Story 4.2)
    export function IBCSFinanceVarianceChart({ data, title, height = 400 }: Props) {
      return (
        <IBCSVarianceChart
          data={transformFinanceToVarianceData(data)}
          title={title}
          height={height}
        />
      )
    }
    ```
  - [ ] Apply IBCS© principles:
    - Semantic colors (green for profit, red for loss/expense)
    - Minimal gridlines (horizontal only)
    - Clear labels (Revenue, COGS, Expenses, Net Income)
    - Zero baseline visible

- [ ] Create IBCS© Finance Table Component (AC: 3, 5)
  - [ ] Create `components/charts/IBCSFinanceTable.tsx`:
    ```tsx
    'use client'

    interface FinanceRow {
      category: string
      actual: number
      previousYear: number
      variancePY: number
      plan: number
      variancePL: number
    }

    interface IBCSFinanceTableProps {
      data: FinanceRow[]
      title: string
    }

    export function IBCSFinanceTable({ data, title }: IBCSFinanceTableProps) {
      const formatCurrency = (num: number) => {
        const sign = num < 0 ? '-' : ''
        return `${sign}$${Math.abs(num).toLocaleString()}`
      }

      const formatVariance = (num: number) => {
        const sign = num >= 0 ? '+' : ''
        return `${sign}$${Math.abs(num).toLocaleString()}`
      }

      return (
        <div className="bg-white rounded-lg border border-gray-200 p-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">{title}</h3>
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead>
                <tr className="bg-gray-50">
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                    Category
                  </th>
                  <th className="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">
                    AC
                  </th>
                  <th className="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">
                    PY
                  </th>
                  <th className="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">
                    ΔPY
                  </th>
                  <th className="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">
                    PL
                  </th>
                  <th className="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">
                    ΔPL
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-100">
                {data.map((row, idx) => (
                  <tr
                    key={idx}
                    className={`hover:bg-gray-50 transition-colors ${
                      row.category === 'Net Income' ? 'border-t-2 border-gray-300 font-semibold' : ''
                    }`}
                  >
                    <td className="px-4 py-3 text-sm text-gray-900 font-medium">
                      {row.category}
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-900 text-right font-mono">
                      {formatCurrency(row.actual)}
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-600 text-right font-mono">
                      {formatCurrency(row.previousYear)}
                    </td>
                    <td className={`px-4 py-3 text-sm text-right font-mono font-semibold ${
                      row.variancePY >= 0 ? 'text-green-700' : 'text-red-700'
                    }`}>
                      {formatVariance(row.variancePY)}
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-600 text-right font-mono">
                      {formatCurrency(row.plan)}
                    </td>
                    <td className={`px-4 py-3 text-sm text-right font-mono font-semibold ${
                      row.variancePL >= 0 ? 'text-green-700' : 'text-red-700'
                    }`}>
                      {formatVariance(row.variancePL)}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )
    }
    ```
  - [ ] Apply IBCS© table principles:
    - Right-align numbers (currency formatted)
    - Left-align text (category names)
    - Bold Net Income row (summary row)
    - Top border on Net Income (visual separator)
    - Semantic colors for variances
    - Monospaced font for currency alignment

- [ ] Create FinanceView Component (AC: 1, 4, 5, 6)
  - [ ] Create `components/results/FinanceView.tsx`:
    ```tsx
    'use client'

    import { useEffect, useState } from 'react'
    import { IBCSWaterfallChart } from '@/components/charts/IBCSWaterfallChart'
    import { IBCSFinanceTable } from '@/components/charts/IBCSFinanceTable'

    interface FinanceViewProps {
      scenarioId: string
    }

    export function FinanceView({ scenarioId }: FinanceViewProps) {
      const [data, setData] = useState(null)
      const [loading, setLoading] = useState(true)
      const [error, setError] = useState<string | null>(null)

      useEffect(() => {
        const fetchFinanceData = async () => {
          try {
            setLoading(true)
            const response = await fetch(`/api/scenarios/${scenarioId}/finance`)

            if (!response.ok) {
              throw new Error('Failed to fetch finance data')
            }

            const result = await response.json()
            setData(result)
          } catch (err) {
            setError(err instanceof Error ? err.message : 'Unknown error')
          } finally {
            setLoading(false)
          }
        }

        fetchFinanceData()
      }, [scenarioId])

      if (loading) {
        return (
          <div className="space-y-6">
            {/* Skeleton UI */}
            <div className="bg-gray-100 rounded-lg h-96 animate-pulse" />
            <div className="bg-gray-100 rounded-lg h-64 animate-pulse" />
          </div>
        )
      }

      if (error) {
        return (
          <div className="bg-red-50 border border-red-200 rounded-lg p-6">
            <p className="text-red-800 font-semibold">Error loading finance data</p>
            <p className="text-red-700">{error}</p>
          </div>
        )
      }

      if (!data) {
        return null
      }

      // Transform API data to chart format
      const chartData = transformToChartData(data)
      const tableData = transformToTableData(data)

      return (
        <div className="space-y-8">
          {/* Single IBCS© Waterfall Chart */}
          <IBCSWaterfallChart
            data={chartData}
            title="Profit & Loss Statement (Waterfall)"
          />

          {/* Single IBCS© Table */}
          <IBCSFinanceTable
            data={tableData}
            title="Financial Performance Overview"
          />
        </div>
      )
    }

    function transformToChartData(apiData: any) {
      // Transform API response to waterfall chart format
      return {
        revenue: apiData.income.revenue.actual,
        cogs: apiData.expenses.cogs.actual,
        expenses: apiData.expenses.operating.actual,
        netIncome: apiData.summary.netIncome.actual,
      }
    }

    function transformToTableData(apiData: any) {
      // Transform API response to table format
      return [
        {
          category: 'Revenue',
          actual: apiData.income.revenue.actual,
          previousYear: apiData.income.revenue.previousYear,
          variancePY: apiData.income.revenue.actual - apiData.income.revenue.previousYear,
          plan: apiData.income.revenue.plan,
          variancePL: apiData.income.revenue.actual - apiData.income.revenue.plan,
        },
        {
          category: 'COGS',
          actual: apiData.expenses.cogs.actual,
          previousYear: apiData.expenses.cogs.previousYear,
          variancePY: apiData.expenses.cogs.actual - apiData.expenses.cogs.previousYear,
          plan: apiData.expenses.cogs.plan,
          variancePL: apiData.expenses.cogs.actual - apiData.expenses.cogs.plan,
        },
        {
          category: 'Operating Expenses',
          actual: apiData.expenses.operating.actual,
          previousYear: apiData.expenses.operating.previousYear,
          variancePY: apiData.expenses.operating.actual - apiData.expenses.operating.previousYear,
          plan: apiData.expenses.operating.plan,
          variancePL: apiData.expenses.operating.actual - apiData.expenses.operating.plan,
        },
        {
          category: 'Net Income',
          actual: apiData.summary.netIncome.actual,
          previousYear: apiData.summary.netIncome.previousYear,
          variancePY: apiData.summary.netIncome.actual - apiData.summary.netIncome.previousYear,
          plan: apiData.summary.netIncome.plan,
          variancePL: apiData.summary.netIncome.actual - apiData.summary.netIncome.plan,
        },
      ]
    }
    ```
  - [ ] Verify `/api/scenarios/[id]/finance` endpoint exists (from Story 2.2)
  - [ ] Test data transformation logic with real API response

- [ ] Responsive Design (AC: 5)
  - [ ] Apply responsive classes (same as Story 4.2):
    - Chart container: `w-full`
    - Chart height: 300px (mobile) vs 400px (desktop)
    - Table: Horizontal scroll on mobile (`overflow-x-auto`)
    - Stack chart and table vertically (`space-y-8`)
  - [ ] Test on multiple viewports

- [ ] Loading States & Error Handling (AC: 6)
  - [ ] Implement skeleton UI (same pattern as Story 4.2)
  - [ ] Implement error state (same pattern as Story 4.2)
  - [ ] Test error scenarios

- [ ] Integration with Story 4.1 Navigation (Integration Test)
  - [ ] Verify FinanceView renders in ViewNavigation context
  - [ ] Test view switching: Finance → Sales → Finance
  - [ ] Verify no memory leaks
  - [ ] Test with multiple scenarios

- [ ] IBCS© Design Review & Polish (AC: 2, 3)
  - [ ] Chart review checklist:
    - [ ] Semantic colors (green profit, red loss) ✅
    - [ ] Minimal gridlines ✅
    - [ ] Clear axis labels ✅
    - [ ] Zero baseline visible ✅
    - [ ] No decorations ✅
    - [ ] Waterfall flow clear (or use simpler variance chart) ✅
  - [ ] Table review checklist:
    - [ ] Right-aligned currency ✅
    - [ ] Net Income row emphasized (bold, top border) ✅
    - [ ] Clear column headers ✅
    - [ ] Semantic variance colors ✅
    - [ ] Sufficient spacing ✅
  - [ ] Get feedback from UX expert (Sally) or user (Mario)

- [ ] Testing & Validation
  - [ ] Manual testing:
    - [ ] Generate scenario and navigate to Finance View
    - [ ] Verify waterfall chart displays correctly
    - [ ] Verify table displays with correct P&L categories
    - [ ] Test responsive behavior
    - [ ] Test loading and error states
  - [ ] Visual regression testing:
    - [ ] Compare with IBCS© examples
    - [ ] Ensure professional appearance
  - [ ] Run `pnpm lint` and `pnpm build`

## Dev Notes

### Waterfall Chart for P&L
[Source: IBCS© financial visualization standards]

**Why Waterfall Chart:**
- **Visual Storytelling**: Shows how revenue flows through COGS and expenses to net income
- **IBCS© Recommended**: Standard chart type for P&L and cash flow statements
- **Clear Causality**: Each bar shows contribution to final result
- **Professional**: Widely used in finance and consulting (McKinsey, BCG, etc.)

**Waterfall Structure:**
```
Revenue (green bar)
  ↓
COGS (red bar, reduces from revenue)
  ↓
Gross Profit (green bar, calculated)
  ↓
Expenses (red bar, reduces from gross profit)
  ↓
Net Income (green/red bar, final result)
```

**IBCS© Color Rules for Finance:**
- **Green**: Positive values (Revenue, Gross Profit, Net Income if positive)
- **Red**: Negative values (COGS, Expenses, Net Income if negative)
- **Gray**: Neutral/reference values (optional)

### Waterfall Chart Implementation Options
[Source: Recharts documentation, Stack Overflow patterns]

**Option 1: Custom Stacked Bars (CHOSEN)**
- Use Recharts `BarChart` with custom cells
- Each bar positioned at running total
- Color cells based on isPositive flag
- Simpler implementation, full IBCS© control

**Option 2: Third-Party Library**
- Use `recharts-waterfall` or similar
- Pre-built waterfall functionality
- Less customization for IBCS© compliance
- Additional dependency

**Option 3: Fallback to Variance Chart**
- If waterfall is too complex, use variance chart (like Story 4.2)
- Show AC, PY, PL for each P&L category
- Still IBCS© compliant
- Easier implementation

**Decision:**
- Try Option 1 (custom waterfall)
- Fallback to Option 3 (variance chart) if waterfall is too complex for MVP timeline

### Finance Table Design
[Source: IBCS© table standards, accounting best practices]

**P&L Categories (in order):**
1. Revenue (income)
2. COGS - Cost of Goods Sold (expense)
3. Gross Profit (calculated: Revenue - COGS)
4. Operating Expenses (expense)
5. **Net Income** (calculated: Gross Profit - Operating Expenses) ← BOLD

**Why Bold Net Income:**
- Summary/total row (most important metric)
- Visual emphasis (reader's eye drawn here)
- Standard accounting practice

**Why Top Border on Net Income:**
- Separates summary from detail
- Visual indicator of calculation break
- IBCS© principle: guide the reader's eye

**Currency Formatting:**
```typescript
formatCurrency(12500)      // "$12,500"
formatCurrency(-3400)      // "-$3,400"
formatVariance(1250)       // "+$1,250"
formatVariance(-500)       // "-$500"
```

### Semantic Colors in Finance
[Source: IBCS© semantic notation rules]

**Color Meanings:**
- **Green (#059669 / green-600)**: Profit, positive variance, good performance
- **Red (#DC2626 / red-600)**: Loss, negative variance, expenses
- **Black (#000)**: Neutral data, baselines
- **Gray (#374151 / gray-700)**: Supporting data, comparisons

**Variance Color Rules:**
- ΔPY positive (actual > previous year): Green ← Good (growth)
- ΔPY negative (actual < previous year): Red ← Bad (decline)
- ΔPL positive (actual > plan): Green ← Good (beat plan)
- ΔPL negative (actual < plan): Red ← Bad (missed plan)

**Exception for Expenses:**
- Expense variance can be inverted (lower expenses = good)
- For simplicity, use standard variance color rules
- Add contextual note if needed

### Data Transformation: API to Chart
[Source: Story 2.2 API structure]

**API Response Format** (from Story 2.2):
```typescript
{
  scenarioId: string,
  income: {
    revenue: { actual: number, previousYear: number, plan: number }
  },
  expenses: {
    cogs: { actual: number, previousYear: number, plan: number },
    operating: { actual: number, previousYear: number, plan: number }
  },
  summary: {
    grossProfit: { actual: number, previousYear: number, plan: number },
    netIncome: { actual: number, previousYear: number, plan: number }
  }
}
```

**Waterfall Chart Data:**
```typescript
{
  revenue: number,      // income.revenue.actual
  cogs: number,         // expenses.cogs.actual (negative)
  expenses: number,     // expenses.operating.actual (negative)
  netIncome: number     // summary.netIncome.actual
}
```

**Table Data:**
Array of rows with category, AC, PY, ΔPY, PL, ΔPL for each P&L line item.

### Simplified from Epic 2
[Source: Epic 2 finance view complexity]

**Epic 2 Finance View (OLD):**
- Multiple charts (revenue breakdown, expense breakdown, trend over time)
- Complex KPI cards
- Multiple color schemes
- Cluttered layout

**Epic 4 Finance View (NEW - THIS STORY):**
- **1 chart**: Waterfall chart (P&L flow)
- **1 table**: Financial performance overview
- Strict IBCS© compliance
- Semantic colors only (green/red/gray)
- Clean, professional layout

**Why Simplify:**
- IBCS© principle: SIMPLIFY (reduce clutter)
- Faster implementation (MVP focus)
- Clearer message (one P&L story)
- Professional appearance

### Responsive Strategy
[Source: Mobile-first design principles]

**Waterfall Chart on Mobile:**
- Reduce height to 300px (less vertical space)
- Rotate X-axis labels -45° (avoid overlap)
- Ensure touch-friendly tooltip

**Table on Mobile:**
- Horizontal scroll (`overflow-x-auto`)
- Sticky first column (optional enhancement)
- Never hide columns (users can scroll)

**Desktop:**
- Full chart height (400px)
- Table fits width (6 columns visible)
- Optimal spacing

### Integration with Story 2.2 API
[Source: Story 2.2 - Finance View Data Layer & API]

**Endpoint:** `GET /api/scenarios/[id]/finance`

**Expected Response Structure:**
See "Data Transformation" section above for full API structure.

**Usage in FinanceView:**
- Fetch on component mount
- Transform to waterfall chart format
- Transform to table format
- Display in IBCS© components

### Error Handling
[Source: Story 3.9 error handling patterns]

**Same patterns as Story 4.2:**
- Skeleton UI during loading
- Error message on failure
- Retry option (optional)
- Console logging for debugging

### Future Enhancements
[Source: Post-MVP planning]

**Potential Additions:**
- Cash flow waterfall chart (operating, investing, financing activities)
- Balance sheet visualization (assets vs liabilities)
- Trend chart (net income over 12 months)
- Drill-down to transaction details
- Export to Excel
- Print-friendly view

### IBCS© Compliance Checklist
[Source: IBCS© certification criteria]

**Chart:**
- [ ] Semantic colors only (green/red/gray, no decorative colors) ✅
- [ ] Minimal gridlines (horizontal only, no vertical) ✅
- [ ] Clear axis labels (no jargon, standard abbreviations) ✅
- [ ] Zero baseline visible (reference line) ✅
- [ ] No 3D effects, shadows, or gradients ✅
- [ ] Professional typography (Inter font, 12px+) ✅
- [ ] Sufficient white space ✅

**Table:**
- [ ] Right-aligned numbers ✅
- [ ] Left-aligned text ✅
- [ ] Monospaced numbers (font-mono) ✅
- [ ] Clear headers (AC, PY, ΔPY, PL, ΔPL) ✅
- [ ] Summary row emphasized (bold, border) ✅
- [ ] Semantic variance colors (green/red) ✅
- [ ] Sufficient row spacing ✅

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-19 | 1.0 | Initial story draft for Epic 4 | Bob (Scrum Master) |
