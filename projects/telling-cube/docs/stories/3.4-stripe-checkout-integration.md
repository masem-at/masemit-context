# Story 3.4: Stripe Checkout Integration

## Status
Ready for Review

## Story
**As a** visitor,
**I want** to purchase a founding member tier via secure payment,
**so that** I can get unlimited scenario access and support the product.

## Acceptance Criteria

1. Stripe account configured with 5 products (Supporter S: ‚Ç¨29, M: ‚Ç¨99, L: ‚Ç¨299, Team Plus: ‚Ç¨599, Department Partner: ‚Ç¨999)
2. API route `/api/stripe/create-checkout` created accepting POST with `{ tier: "supporterS" | "supporterM" | ... }`
3. Endpoint creates Stripe Checkout Session and returns checkout URL
4. User clicking tier button on landing page calls API and redirects to Stripe hosted checkout page
5. Stripe success URL redirects to `/confirmation` page with session_id parameter; cancel URL redirects back to landing page

## Tasks / Subtasks

- [x] Set Up Stripe Account & Products (AC: 1) - **MANUAL SETUP REQUIRED**
  - [x] Create Stripe account at stripe.com (if not exists)
  - [x] Switch to Test mode for development
  - [x] Create 5 products in Stripe Dashboard:
    - Supporter S: ‚Ç¨29 one-time payment
    - Supporter M: ‚Ç¨99 one-time payment
    - Supporter L: ‚Ç¨299 one-time payment
    - Team Plus: ‚Ç¨599 one-time payment
    - Department Partner: ‚Ç¨999 one-time payment
  - [x] Copy price IDs for each tier (e.g., `price_abc123`)
  - [x] Add to environment variables

- [x] Configure Environment Variables
  - [x] Add to `.env.local`:
    ```
    STRIPE_SECRET_KEY=sk_test_...
    STRIPE_PUBLISHABLE_KEY=pk_test_...
    NEXT_PUBLIC_BASE_URL=http://localhost:3000 (dev) or https://tellingcube.com (prod)

    # Price IDs from Stripe Dashboard
    STRIPE_PRICE_SUPPORTER_S=price_...
    STRIPE_PRICE_SUPPORTER_M=price_...
    STRIPE_PRICE_SUPPORTER_L=price_...
    STRIPE_PRICE_TEAM_PLUS=price_...
    STRIPE_PRICE_DEPARTMENT_PARTNER=price_...
    ```
  - [x] Add `.env.local` to `.gitignore` (should already be there)
  - [x] Document env vars in README or `.env.example`

- [x] Install Stripe SDK (AC: 2, 3)
  - [x] Run: `pnpm add stripe`
  - [x] Verify version: Stripe Node.js SDK v14+ (installed v20.0.0)

- [x] Create Checkout Session API Route (AC: 2, 3)
  - [ ] Create file: `app/api/stripe/create-checkout/route.ts`
  - [ ] Import Stripe SDK:
    ```typescript
    import Stripe from 'stripe'
    const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
      apiVersion: '2024-11-20.acacia',
    })
    ```
  - [ ] Define tier type and price mapping:
    ```typescript
    type TierType = 'supporterS' | 'supporterM' | 'supporterL' | 'teamPlus' | 'departmentPartner'

    const PRICE_IDS: Record<TierType, string> = {
      supporterS: process.env.STRIPE_PRICE_SUPPORTER_S!,
      supporterM: process.env.STRIPE_PRICE_SUPPORTER_M!,
      supporterL: process.env.STRIPE_PRICE_SUPPORTER_L!,
      teamPlus: process.env.STRIPE_PRICE_TEAM_PLUS!,
      departmentPartner: process.env.STRIPE_PRICE_DEPARTMENT_PARTNER!,
    }
    ```
  - [ ] Implement POST handler:
    ```typescript
    export async function POST(request: Request) {
      try {
        const { tier } = await request.json()

        const session = await stripe.checkout.sessions.create({
          mode: 'payment',
          line_items: [{ price: PRICE_IDS[tier as TierType], quantity: 1 }],
          success_url: `${process.env.NEXT_PUBLIC_BASE_URL}/confirmation?session_id={CHECKOUT_SESSION_ID}`,
          cancel_url: `${process.env.NEXT_PUBLIC_BASE_URL}/`,
        })

        return Response.json({ url: session.url })
      } catch (error) {
        return Response.json({ error: 'Failed to create checkout session' }, { status: 500 })
      }
    }
    ```

- [ ] Integrate with Landing Page (AC: 4) - **Story 3.5 handles UI**
  - [ ] Note: Story 3.5 will add pricing cards to landing page
  - [ ] This story provides API endpoint that Story 3.5 will call
  - [ ] Frontend integration happens in Story 3.5

- [ ] Configure Success & Cancel URLs (AC: 5)
  - [ ] Success URL: `/confirmation?session_id={CHECKOUT_SESSION_ID}`
    - Stripe replaces {CHECKOUT_SESSION_ID} with actual session ID
    - Story 3.6 will create /confirmation page
  - [ ] Cancel URL: `/` (homepage)
    - User returns to landing page if they cancel

- [ ] Test Stripe Integration
  - [ ] Use Stripe test mode with test card: 4242 4242 4242 4242
  - [ ] Test API endpoint manually:
    ```bash
    curl -X POST http://localhost:3000/api/stripe/create-checkout \
      -H "Content-Type: application/json" \
      -d '{"tier": "supporterS"}'
    ```
  - [ ] Verify response contains checkout URL
  - [ ] Click checkout URL ‚Üí redirects to Stripe hosted page
  - [ ] Complete test payment ‚Üí redirects to /confirmation
  - [ ] Cancel payment ‚Üí redirects to homepage

- [ ] Add Error Handling & Validation
  - [ ] Validate tier parameter:
    ```typescript
    if (!tier || !PRICE_IDS[tier as TierType]) {
      return Response.json({ error: 'Invalid tier' }, { status: 400 })
    }
    ```
  - [ ] Validate environment variables at startup:
    ```typescript
    if (!process.env.STRIPE_SECRET_KEY) {
      throw new Error('STRIPE_SECRET_KEY not configured')
    }
    ```
  - [ ] Handle Stripe API errors gracefully
  - [ ] Log errors for monitoring

- [ ] Code Quality & Documentation
  - [ ] Add JSDoc comments to API route
  - [ ] Document tier types and price mappings
  - [ ] TypeScript strict mode compliance
  - [ ] Run `pnpm lint` and `pnpm build`

## Dev Notes

### Stripe Configuration
[Source: docs/architecture/tech-stack.md - Stripe Checkout]

**Tech Stack:**
- Stripe Checkout (hosted payment pages)
- Stripe Node.js SDK v14+
- One-time payments (no subscriptions for MVP)

**Why Stripe Checkout:**
- Handles all payment UI/security
- PCI compliance delegated to Stripe
- Webhooks for payment confirmations
- Test mode for development

### Pricing Tiers
[Source: PRD - FR9]

**Founding Member Tiers:**
1. **Supporter S**: ‚Ç¨29 (individual, early supporter)
2. **Supporter M**: ‚Ç¨99 (individual, stronger support)
3. **Supporter L**: ‚Ç¨299 (power user, professional)
4. **Team Plus**: ‚Ç¨599 (small team, 5-10 people)
5. **Department Partner**: ‚Ç¨999 (department/organization)

**All tiers include:**
- Unlimited scenario generations
- Lifetime access
- Grandfathered pricing (no price increases)
- Priority support
- Early access to new features

### File Locations
[Source: docs/architecture/source-tree.md - API Routes]

**Files to Create:**
- `app/api/stripe/create-checkout/route.ts` - Checkout session creation

**Future Files (Story 3.7):**
- `app/api/stripe/webhook/route.ts` - Payment webhooks

### Stripe API Integration Pattern
```typescript
import Stripe from 'stripe'
import { NextResponse } from 'next/server'

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2024-11-20.acacia',
})

export async function POST(request: Request) {
  try {
    const { tier } = await request.json()

    // Validate tier
    const priceId = PRICE_IDS[tier as TierType]
    if (!priceId) {
      return NextResponse.json(
        { error: 'Invalid tier specified' },
        { status: 400 }
      )
    }

    // Create checkout session
    const session = await stripe.checkout.sessions.create({
      mode: 'payment',
      line_items: [{
        price: priceId,
        quantity: 1,
      }],
      success_url: `${process.env.NEXT_PUBLIC_BASE_URL}/confirmation?session_id={CHECKOUT_SESSION_ID}`,
      cancel_url: `${process.env.NEXT_PUBLIC_BASE_URL}/`,
    })

    return NextResponse.json({ url: session.url })
  } catch (error) {
    console.error('Stripe checkout error:', error)
    return NextResponse.json(
      { error: 'Failed to create checkout session' },
      { status: 500 }
    )
  }
}
```

### Environment Variables
[Source: Story 3.9 - Environment validation]

**Required Environment Variables:**
```bash
# Stripe API Keys (get from stripe.com/dashboard)
STRIPE_SECRET_KEY=sk_test_51...  # Secret key (server-side only)
STRIPE_PUBLISHABLE_KEY=pk_test_51...  # Public key (not needed for server-side Checkout)

# Base URL for redirects
NEXT_PUBLIC_BASE_URL=http://localhost:3000  # Development
NEXT_PUBLIC_BASE_URL=https://tellingcube.com  # Production

# Stripe Price IDs (copy from Stripe Dashboard after creating products)
STRIPE_PRICE_SUPPORTER_S=price_1A2B3C...
STRIPE_PRICE_SUPPORTER_M=price_1D4E5F...
STRIPE_PRICE_SUPPORTER_L=price_1G6H7I...
STRIPE_PRICE_TEAM_PLUS=price_1J8K9L...
STRIPE_PRICE_DEPARTMENT_PARTNER=price_1M0N1O...
```

### TypeScript Type Definitions
```typescript
type TierType =
  | 'supporterS'
  | 'supporterM'
  | 'supporterL'
  | 'teamPlus'
  | 'departmentPartner'

interface CreateCheckoutRequest {
  tier: TierType
}

interface CreateCheckoutResponse {
  url: string
}

interface CheckoutError {
  error: string
}
```

### Testing Strategy
[Source: Epic 1/2 manual testing patterns]

**Manual Test Checklist:**
- [ ] API responds with checkout URL for each tier
- [ ] Stripe test card (4242 4242 4242 4242) completes payment
- [ ] Success redirect includes session_id parameter
- [ ] Cancel redirect returns to homepage
- [ ] Invalid tier returns 400 error
- [ ] Missing env vars throw error at startup

**Stripe Test Cards:**
- Success: 4242 4242 4242 4242
- Decline: 4000 0000 0000 0002
- 3D Secure: 4000 0025 0000 3155

### Security Considerations
[Source: NFR6 - Security]

**API Key Security:**
- STRIPE_SECRET_KEY must NEVER be exposed to client
- Use server-side API routes only (not client components)
- Add to `.env.local` (git-ignored)

**Input Validation:**
- Validate tier parameter before using
- Sanitize all inputs
- Return generic errors (don't expose internal details)

**PCI Compliance:**
- No credit card data touches our servers
- Stripe handles all payment processing
- We only get session_id after successful payment

### Known Constraints
[Source: PRD - Post-PoC deferred items]

**MVP Scope:**
- One-time payments only (no subscriptions)
- No customer accounts (ephemeral mode)
- Basic error handling (production logging deferred to Story 3.9)
- Test mode only initially (switch to live mode at launch)

**Post-PoC Enhancements:**
- Customer portal for receipt management
- Subscription billing (if business model changes)
- Multi-currency support
- Invoice generation

### Integration with Other Stories

**Dependencies:**
- **Story 3.5** (Pricing Section): Will call this API endpoint
- **Story 3.6** (Confirmation Page): Receives session_id from success URL
- **Story 3.7** (Email Confirmation): Webhook triggers email send

**Flow:**
1. User clicks "Get Supporter S" button (Story 3.5)
2. Frontend calls `/api/stripe/create-checkout` (THIS STORY)
3. API returns Stripe checkout URL
4. Browser redirects to Stripe hosted page
5. User completes payment
6. Stripe redirects to `/confirmation?session_id=...` (Story 3.6)
7. Stripe sends webhook event (Story 3.7 sends email)

## Dev Agent Record

### Agent Model Used
- claude-sonnet-4-5-20250929

### Completion Notes
- User completed manual Stripe setup (Tasks 1-2): Created Stripe account, configured 5 products in test mode, obtained API keys and Price IDs
- Installed Stripe SDK v20.0.0 (`pnpm add stripe`)
- Created `/api/stripe/create-checkout/route.ts` API endpoint with:
  - Stripe initialization with latest API version (2025-11-17.clover)
  - Tier type definitions (supporterS, supporterM, supporterL, teamPlus, departmentPartner)
  - Price ID mapping from environment variables
  - Comprehensive error handling and validation (tier validation, env var checks)
  - JSDoc documentation
  - Proper success/cancel URL configuration
- All validation and security measures implemented:
  - Input validation for tier parameter
  - Environment variable validation
  - Generic error messages (no internal details exposed)
  - Server-side only (Stripe secret key never exposed to client)
- Build and lint passed successfully ‚úÖ
- Note: Frontend integration deferred to Story 3.5 (PricingSection will call this API)
- Note: Confirmation page deferred to Story 3.6
- Note: Manual testing with Stripe test cards deferred until Story 3.5 completes UI

### File List
- `package.json` (modified) - Added stripe@20.0.0 dependency
- `pnpm-lock.yaml` (modified) - Package lock update
- `app/api/stripe/create-checkout/route.ts` (created) - Checkout session API endpoint

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-19 | 1.0 | Initial story draft for Epic 3 | Bob (Scrum Master) |
| 2025-11-19 | 1.1 | Story completed - Stripe checkout API implemented | James (Dev) |

## QA Results

### Review Date: 2025-11-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Grade: GOOD (75/100)**

The Stripe checkout API implementation is clean, well-structured, and functional. Code follows TypeScript strict mode and coding standards. Excellent JSDoc documentation. However, missing rate limiting on a payment endpoint is a security concern that should be addressed before production.

**Strengths:**
- ‚úÖ Clean code structure with proper separation of concerns
- ‚úÖ Comprehensive validation (tier validation, type checking, env var checks)
- ‚úÖ Excellent JSDoc documentation with request/response examples
- ‚úÖ Proper error handling with try-catch and generic client errors
- ‚úÖ TypeScript strict mode compliance
- ‚úÖ Security-conscious (server-side only, no secret exposure, generic errors)
- ‚úÖ Latest Stripe API version (2025-11-17.clover)
- ‚úÖ PCI compliance via Stripe hosted checkout

**Concerns:**
- ‚ö†Ô∏è **HIGH: No rate limiting** - Attacker could create unlimited checkout sessions
- ‚ö†Ô∏è **MEDIUM: Env var validation at module level** - Uses `!` assertion instead of startup validation
- ‚ö†Ô∏è **MEDIUM: No automated tests** - Manual testing deferred to Story 3.5 (acceptable for PoC)

### Refactoring Performed

- **File**: `app/api/stripe/create-checkout/route.ts`
  - **Change**: Added explicit return type `Promise<Response>` to POST function (line 41)
  - **Why**: Coding standards recommend explicit return types for exported functions
  - **How**: Improves type safety and code documentation
  - **Result**: ‚úÖ Build passed after refactoring

### Compliance Check

- ‚úÖ **Coding Standards**: Excellent adherence to TypeScript/Next.js conventions. Added explicit return type per standards.
- ‚úÖ **Project Structure**: API route correctly placed in `app/api/stripe/create-checkout/`
- ‚ö†Ô∏è **Testing Strategy**: No automated tests (acknowledged in story, acceptable for PoC)
- ‚úÖ **All ACs Met**: 4/5 acceptance criteria satisfied. AC4 intentionally deferred to Story 3.5 per story design.

### Requirements Traceability

All acceptance criteria validated with Given-When-Then scenarios:

**AC1 - Stripe Account Configured**: ‚úÖ PASS
- Given: User completed manual Stripe setup
- When: 5 products created in test mode
- Then: Price IDs obtained and stored in environment variables
- Evidence: Confirmed in Dev Agent Record

**AC2 - API Route Created**: ‚úÖ PASS
- Given: Next.js App Router project
- When: File `app/api/stripe/create-checkout/route.ts` created
- Then: POST endpoint accepts `{ tier: TierType }` payload
- Evidence: File exists at route.ts:41-99

**AC3 - Checkout Session Creation**: ‚úÖ PASS
- Given: Valid tier parameter sent to endpoint
- When: Stripe API called with price ID
- Then: Response contains `{ url: "https://checkout.stripe.com/..." }`
- Evidence: Implemented at route.ts:74-87

**AC4 - Frontend Integration**: ‚ö†Ô∏è DEFERRED
- Given: Landing page with tier buttons
- When: User clicks tier button
- Then: Frontend calls API and redirects
- Status: Intentionally deferred to Story 3.5 per story design

**AC5 - Success/Cancel URLs**: ‚úÖ PASS
- Given: Checkout session creation
- When: Session created with redirect URLs
- Then: Success URL includes session_id, cancel URL returns to homepage
- Evidence: Implemented at route.ts:82-83

### Improvements Checklist

Items I handled during review:

- [x] Added explicit return type to POST function (route.ts:41)
- [x] Verified coding standards compliance
- [x] Confirmed TypeScript strict mode compliance
- [x] Validated error handling implementation

Items for dev team to address:

- [ ] Add rate limiting to prevent API abuse (HIGH priority - immediate)
- [ ] Include Stripe env vars in Story 3.9 startup validation (MEDIUM priority)
- [ ] Add integration tests post-MVP (MEDIUM priority - future)
- [ ] Add request logging/audit trail (LOW priority - future)

### Security Review

**Status: ‚ö†Ô∏è CONCERNS** - Functional but needs rate limiting

**‚úÖ Security Strengths:**
- Server-side only (no client-side secret exposure)
- Environment variables for secrets (.env.local git-ignored)
- Generic error messages (no stack trace leaks)
- Stripe handles all PCI compliance
- No credit card data touches servers
- Input validation (tier type checking)
- Environment variable validation

**‚ö†Ô∏è Security Concerns:**
1. **HIGH: No rate limiting** (SEC-001)
   - Risk: Attacker could create unlimited checkout sessions
   - Impact: API abuse, DoS attacks, Stripe quota exhaustion
   - Recommendation: Add rate limiting (e.g., 10 sessions/hour per IP)
   - Action: Consider adding to Story 3.9 or create separate security story

2. **MEDIUM: Env var validation timing** (CODE-001)
   - Risk: Runtime crashes if env vars missing vs graceful startup failure
   - Impact: Poor developer experience, unclear error messages
   - Recommendation: Story 3.9 addresses this - ensure Stripe vars included

3. **LOW: No request logging** - Harder to detect abuse patterns
   - Impact: Limited audit trail for debugging
   - Recommendation: Story 3.9 adds Sentry logging

**Note:** Story 3.9 plans rate limiting for `/api/generate` but does not mention `/api/stripe/create-checkout`. Payment endpoints should also be rate-limited.

### Performance Considerations

**Status: ‚úÖ EXCELLENT**

- Lightweight endpoint (~100 lines of code)
- Single external API call (Stripe)
- No database queries
- No complex computations
- Stateless design
- Fast response expected (<500ms)
- Stripe SDK handles connection pooling
- Minimal memory footprint

### NFR Validation

- **Security**: ‚ö†Ô∏è CONCERNS - See Security Review section above
- **Performance**: ‚úÖ PASS - Lightweight with fast response
- **Reliability**: ‚úÖ PASS - Comprehensive error handling, graceful degradation
- **Maintainability**: ‚úÖ PASS - Clean code with excellent documentation

### Technical Debt

**Acknowledged:**
- No automated tests (deferred per PoC strategy) - LOW impact
- No rate limiting (security risk) - HIGH impact
- Env var validation at module level vs startup - MEDIUM impact

**Recommendations:**
1. **Immediate** (before production):
   - Add rate limiting to checkout endpoint
   - Include Stripe env vars in Story 3.9 startup validation

2. **Future** (post-MVP):
   - Add integration tests for payment flow
   - Add request logging/audit trail
   - Consider retry logic for Stripe API failures

### Files Modified During Review

- `app/api/stripe/create-checkout/route.ts` - Added explicit return type (line 41)

**Note to Dev:** Please update File List in Dev Agent Record to include this QA change.

### Gate Status

**Gate: CONCERNS** ‚Üí `docs/qa/gates/3.4-stripe-checkout-integration.yml`

**Quality Score: 75/100**

Calculation: 100 - (20 √ó 0 FAILs) - (10 √ó 3 CONCERNS) + 5 (minor bonus for excellent code quality)

**Top Issues:**
1. SEC-001 (HIGH): No rate limiting on payment endpoint
2. CODE-001 (MEDIUM): Env var validation timing
3. TEST-001 (MEDIUM): No automated tests

### Recommended Status

‚ö†Ô∏è **Acceptable for Story 3.5 Integration, but Address Before Production**

This story meets its defined scope (backend API only). The implementation is clean and functional. However, the missing rate limiting is a genuine security concern that should be addressed before production deployment.

**Recommendations:**
1. ‚úÖ **Proceed to Story 3.5** - Frontend can integrate with this API
2. ‚ö†Ô∏è **Add rate limiting before production** - Consider adding to Story 3.9 scope
3. ‚úÖ **Manual testing in Story 3.5** - Test with real Stripe checkout flow
4. üìã **Create security follow-up** - If Story 3.9 doesn't cover payment endpoint rate limiting

**Story owner decides final status.**
