# Story 3.2: Generation Loading State & Progress Indicator

## Status
Approved

## Story
**As a** user,
**I want** engaging visual feedback during scenario generation with progress tracking, value reinforcement, and educational content,
**so that** the 1-3 minute wait time feels productive rather than frustrating, and I understand the value being created.

## Acceptance Criteria

1. **Progress Storytelling Overlay** created with:
   - Full-screen centered layout with tellingCube.com logo
   - Progress bar (0-100%) with smooth animations
   - Step-by-step progress indicators showing what's happening:
     - ‚úÖ "Generating Q1 2024 transactions (142 events)" ‚Üí COMPLETE
     - ‚è≥ "Creating customer purchase patterns..." ‚Üí IN PROGRESS
     - ‚è∏Ô∏è "Calculating financial reconciliations" ‚Üí PENDING
     - ‚è∏Ô∏è "Validating cross-departmental consistency" ‚Üí PENDING
   - Estimated time: "Typically takes 90-120 seconds" displayed prominently

2. **Value Reinforcement Messaging** displayed during wait:
   - Header: "Generating Your [Scenario Type] Scenario"
   - Subtext: "Creating 1 year of realistic, mathematically consistent business data..."
   - Value card showing:
     - üíº "Manual effort saved: ~3-4 hours"
     - üìä "AI doing the work of a data scientist"
     - ‚úÖ "Mathematical consistency guaranteed"
     - üéØ "IBCS-compliant visualizations included"
   - Comparison: "Doing this in Excel would take 3-4 hours. We'll have it ready in 2 minutes."

3. **Educational Carousel** (rotating tips every 10 seconds):
   - Tip 1: "üí° Your scenario includes AC (Actual), PY (Previous Year), and PL (Plan) data"
   - Tip 2: "üìä All charts follow IBCS v1.2 standards for professional business reporting"
   - Tip 3: "üîó Sales and Finance views draw from the same event stream‚Äîguaranteed consistency"
   - Tip 4: "‚ö° Every scenario includes 365 days of transactions across multiple departments"
   - Tips cycle automatically, can be paused on hover

4. **Redirect & Error Handling**:
   - On successful generation: automatically redirects to `/results/[scenarioId]` with brief success message
   - Cancel button at bottom: returns user to homepage (logs cancellation for analytics)
   - Timeout after 5 minutes: displays user-friendly error with "Try Again" button
   - Error states show clear messaging without technical jargon

5. **Responsive & Accessible Design**:
   - Works on mobile (375px), tablet (768px), and desktop (1024px+)
   - Progress updates announced to screen readers (aria-live regions)
   - Smooth animations that don't cause motion sickness (respects prefers-reduced-motion)
   - Loading state accessible with proper ARIA labels

## Tasks / Subtasks

- [ ] Create Loading Page Route (AC: 1)
  - [ ] Create `app/generate/loading/page.tsx` file
    - Use 'use client' directive for client-side interactivity
    - Import React hooks (useState, useEffect), Next.js router
    - Set up page metadata (title: "Generating Scenario - tellingCube")
  - [ ] Implement full-screen centered layout:
    - Container: `min-h-screen bg-gray-50 flex items-center justify-center`
    - Content wrapper: `max-w-md mx-auto p-6 text-center`
  - [ ] Add tellingCube.com logo:
    - Text logo: `text-2xl font-bold text-blue-600 mb-8`
    - Or use logo image if available in `/public/images/logo.svg`
  - [ ] Create animated spinner component:
    - Use Tailwind animation: `animate-spin`
    - Circular border: `border-4 border-blue-600 border-t-transparent rounded-full`
    - Size: `w-16 h-16` for visibility
    - Alternative: Use green accent `border-green-500` for progress indicator

- [ ] Implement Dynamic Status Text (AC: 1)
  - [ ] Create status message state:
    ```typescript
    const [statusMessage, setStatusMessage] = useState('Generating 1 year of bakery data...')
    ```
  - [ ] Implement status progression with useEffect:
    - Start: "Generating 1 year of [scenario] data..."
    - After 15s: "Creating Sales view..."
    - After 30s: "Validating consistency..."
    - Final: "Almost ready..."
  - [ ] Display status text:
    - Typography: `text-lg text-gray-700 mb-4`
    - Smooth transitions: `transition-opacity duration-300`
  - [ ] Get scenario type from URL search params or session storage

- [ ] Add Time Remaining Estimator (AC: 1)
  - [ ] Create time remaining state:
    ```typescript
    const [timeRemaining, setTimeRemaining] = useState(60)
    ```
  - [ ] Implement countdown timer with useEffect:
    - Start at 60 seconds (estimated total time)
    - Decrement every second
    - Stop at 0 or when generation completes
  - [ ] Display time remaining:
    - Format: "~45 seconds remaining"
    - Typography: `text-sm text-gray-600`
    - Hide when <5 seconds remaining (show "Almost ready...")

- [ ] Implement Generation Polling or Status Tracking (AC: 2)
  - [ ] Determine generation approach:
    - **Option A**: Synchronous (wait for API response from Story 3.1)
    - **Option B**: Async polling (poll `/api/generate/status/:jobId`)
  - [ ] If Option A (Synchronous):
    - Navigate directly from Story 3.1 after API completes
    - Loading page shows while waiting (no polling needed)
    - Skip polling implementation
  - [ ] If Option B (Async with polling):
    - Get jobId from URL params or query string
    - Poll `/api/generate/status/:jobId` every 2 seconds
    - Check response for completion status
    ```typescript
    useEffect(() => {
      const interval = setInterval(async () => {
        const response = await fetch(`/api/generate/status/${jobId}`)
        const data = await response.json()
        if (data.status === 'completed') {
          router.push(`/results/${data.scenarioId}`)
        }
      }, 2000)
      return () => clearInterval(interval)
    }, [jobId])
    ```

- [ ] Implement Automatic Redirect on Success (AC: 3)
  - [ ] Add router navigation:
    ```typescript
    import { useRouter } from 'next/navigation'
    const router = useRouter()
    ```
  - [ ] Navigate to results page on completion:
    - Get scenarioId from API response or polling
    - `router.push(/results/${scenarioId})`
  - [ ] Add transition feedback before redirect:
    - Show checkmark icon or success message
    - Brief delay (500ms) for user to see completion
    - Then auto-navigate

- [ ] Add Cancel Button (AC: 4 - Optional)
  - [ ] Create cancel button at bottom of page:
    - Style: `text-gray-600 hover:text-gray-800 underline`
    - Position: Below spinner and status text
    - Label: "Cancel" or "Go Back"
  - [ ] Implement cancel handler:
    ```typescript
    const handleCancel = () => {
      // Log cancellation (optional analytics)
      console.log('Generation cancelled by user')
      // Navigate back to homepage
      router.push('/')
    }
    ```
  - [ ] Add confirmation dialog (optional):
    - "Are you sure you want to cancel generation?"
    - For MVP: Skip confirmation, just navigate back

- [ ] Implement Error Handling & Timeout (AC: 5)
  - [ ] Add error state:
    ```typescript
    const [error, setError] = useState<string | null>(null)
    ```
  - [ ] Implement 5-minute timeout:
    ```typescript
    useEffect(() => {
      const timeout = setTimeout(() => {
        setError('Generation took too long. Please try again.')
      }, 5 * 60 * 1000) // 5 minutes
      return () => clearTimeout(timeout)
    }, [])
    ```
  - [ ] Display error UI when error occurs:
    - Error message: `text-red-600 bg-red-50 p-4 rounded-lg`
    - "Try Again" button: Links back to homepage
    - Error icon: Use Lucide `AlertCircle` or similar
  - [ ] Handle API errors:
    - Catch fetch errors in polling logic
    - Display user-friendly message (not technical stack trace)

- [ ] Add Responsive Design & Accessibility (AC: All)
  - [ ] Mobile-first responsive layout:
    - Works on 375px width (mobile)
    - Adjust spacing for larger screens
  - [ ] Accessibility features:
    - Aria-live region for status updates
    - Semantic HTML (main, section tags)
    - Focus management for error state
  - [ ] Loading animation accessibility:
    - Add aria-label="Loading..." to spinner
    - Ensure screen readers announce status changes

- [ ] Code Quality & Testing (AC: All)
  - [ ] Add JSDoc comments:
    - Document page purpose
    - Explain polling logic (if used)
    - Note timeout behavior
  - [ ] TypeScript type safety:
    - Define GenerationStatus interface
    - Type all state variables
    - Type API responses
  - [ ] Run validations:
    - `pnpm lint` - fix warnings
    - `pnpm build` - verify no errors
  - [ ] Manual testing:
    - Trigger generation from Story 3.1
    - Verify loading page appears
    - Check status messages update
    - Confirm redirect to results page
    - Test error scenarios (timeout, API failure)

## Dev Notes

### Team Brainstorm Context (2025-11-19)
[Source: Party-mode brainstorm session with James (Dev), Quinn (QA), and user feedback]

**Problem Statement:**
- Scenario generation takes 30-180 seconds (avg 90-120 seconds)
- Users staring at spinner feels slow, even though it's 100x faster than manual Excel work
- Risk: Users perceive the wait as "slow" and abandon the process
- Paradox: We're selling SPEED, but wait time feels long without engagement

**Team Solutions (Implemented in this story):**
1. **Progress Storytelling** (James, Bob) - Show step-by-step what's happening behind the scenes
2. **Value Reinforcement** (Bob, Quinn) - Remind user of time/effort saved during wait
3. **Progress Indicators** (Quinn) - Time estimates and percentage complete reduce anxiety
4. **Educational Content** (James, Bob) - IBCS tips and use cases add value to wait time

**Deferred Features (Post-PoC):**
- ‚ùå Interactive Poll - Would require backend API + database schema (too complex for MVP)
- ‚ùå Async Generation with Email Notification - Requires authentication system
- ‚ùå Real-time Progress via WebSockets - Added complexity, polling fallback sufficient for MVP

**Design Decision:**
Pure frontend implementation - NO backend changes, NO database needed. All progress is simulated based on elapsed time. This keeps the story simple and achievable within 3-4 hours.

### Previous Story Insights
[Source: Story 3.1 Implementation Context]

**Integration with Story 3.1:**
- Story 3.1 triggers generation via POST `/api/generate`
- After POST, user should navigate to `/generate/loading`
- Or implement synchronous wait with loading overlay on homepage

**Navigation Flow:**
1. User clicks "Generate Bakery Scenario" (Story 3.1)
2. POST `/api/generate` initiates
3. Navigate to `/generate/loading?type=bakery` or similar
4. Loading page polls/waits for completion
5. Auto-redirect to `/results/{scenarioId}`

### File Locations
[Source: docs/architecture/source-tree.md]

**Files to Create:**
- `app/generate/loading/page.tsx` - Loading page component

**Files to Reference:**
- `app/api/generate/route.ts` - Generation endpoint (Epic 1)
- May need: `app/api/generate/status/[jobId]/route.ts` - Status polling endpoint (if async)

**Import Paths:**
- Router: `import { useRouter } from 'next/navigation'`
- React: `import { useState, useEffect } from 'react'`
- Icons (optional): `import { Loader2, AlertCircle, CheckCircle } from 'lucide-react'`

### Component Structure Pattern
[Source: Next.js 14 App Router best practices]

```typescript
'use client'

import { useState, useEffect } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'

export default function GenerateLoadingPage() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const scenarioType = searchParams.get('type') || 'bakery'

  const [statusMessage, setStatusMessage] = useState(`Generating 1 year of ${scenarioType} data...`)
  const [timeRemaining, setTimeRemaining] = useState(60)
  const [error, setError] = useState<string | null>(null)

  // Status progression logic
  useEffect(() => {
    // Update status messages over time
  }, [])

  // Countdown timer
  useEffect(() => {
    // Decrement timeRemaining
  }, [])

  // Timeout handling
  useEffect(() => {
    // Set error after 5 minutes
  }, [])

  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
      {/* Loading UI */}
    </div>
  )
}
```

### Brand Colors & Animation
[Source: Story 2.8 Dev Notes - Brand Color Consistency]

**Colors:**
- Primary Blue: `#2563EB` (blue-600) - Spinner border
- Success Green: `#10B981` (green-500) - Progress indicator accent
- Background: `#F9FAFB` (gray-50)
- Text: `#374151` (gray-700)
- Error Red: `#DC2626` (red-600)

**Spinner Animation:**
```tsx
<div className="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-6" />
```

**Alternative Progress Indicator:**
- Use dual-color spinner (blue + green)
- Or progress bar: `<div className="w-full bg-gray-200 rounded-full h-2"><div className="bg-blue-600 h-2 rounded-full" style={{width: `${progress}%`}}/></div>`

### Generation Time Estimates
[Source: NFR1 - Scenario generation under 5 minutes]

**Expected Generation Times:**
- Target: <3 minutes (180 seconds)
- 90th percentile: <5 minutes (300 seconds)
- Timeout: 5 minutes (300 seconds)

**Status Message Timing:**
- 0-15s: "Generating 1 year of [scenario] data..."
- 15-30s: "Creating Sales view..."
- 30-45s: "Validating consistency..."
- 45s+: "Almost ready..."

**Time Remaining Display:**
- Start at 60 seconds (conservative estimate)
- Update every second
- Hide when <5 seconds (to avoid showing "0 seconds" if delayed)

### Async vs Sync Generation Approach
[Source: Story 1.6 implementation - needs verification]

**Current Implementation (to verify):**
- Story 1.6 created `/api/generate` endpoint
- Likely synchronous (waits for Claude API response)
- Response time: 30-180 seconds

**Decision Points:**
- **If synchronous**: Loading state in Story 3.1, navigate directly to results
- **If async**: Navigate to `/generate/loading`, poll for status

**Recommendation for MVP:**
- Use synchronous approach with loading overlay on Story 3.1 page
- Defer `/generate/loading` page to post-PoC
- **OR** implement simple loading page without polling (just wait for navigation)

**For this story (MVP scope):**
- Assume synchronous generation
- Create loading page that displays while waiting
- No polling needed (Story 3.1 handles API call)
- Auto-redirect handled by Story 3.1 after response

### URL Patterns & Navigation
[Source: Next.js 14 App Router routing conventions]

**Loading Page URL Options:**
1. `/generate/loading?type=bakery&jobId=xyz` - Query params
2. `/generate/[jobId]/loading` - Dynamic route
3. Simple: `/generate/loading` - Static route

**Recommended for MVP:**
- Static route: `/generate/loading`
- Pass scenario type via query param: `?type=bakery`
- Or use session storage to persist scenario type

**Navigation Flow:**
```typescript
// In Story 3.1 - Homepage
const handleGenerateScenario = async (scenarioType: string) => {
  router.push(`/generate/loading?type=${scenarioType}`)
  const response = await fetch('/api/generate', {...})
  const data = await response.json()
  router.push(`/results/${data.scenarioId}`)
}
```

### Error Handling Patterns
[Source: docs/architecture/coding-standards.md - Error Handling]

**Timeout Implementation:**
```typescript
useEffect(() => {
  const timeoutId = setTimeout(() => {
    setError('Generation is taking longer than expected. Please try again.')
  }, 5 * 60 * 1000) // 5 minutes

  return () => clearTimeout(timeoutId)
}, [])
```

**API Error Handling:**
```typescript
try {
  const response = await fetch('/api/generate/status/jobId')
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}`)
  }
  const data = await response.json()
  // Handle success
} catch (error) {
  console.error('Generation failed:', error)
  setError('Something went wrong. Please try again.')
}
```

**Error UI:**
```tsx
{error && (
  <div className="bg-red-50 border border-red-200 text-red-800 p-4 rounded-lg">
    <p className="font-medium">Generation Failed</p>
    <p className="text-sm mt-1">{error}</p>
    <button
      onClick={() => router.push('/')}
      className="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
    >
      Try Again
    </button>
  </div>
)}
```

### Accessibility Considerations
[Source: NFR9 - WCAG 2.1 compliance]

**Live Regions for Dynamic Content:**
```tsx
<div aria-live="polite" aria-atomic="true">
  {statusMessage}
</div>
```

**Spinner Accessibility:**
```tsx
<div
  className="animate-spin..."
  role="status"
  aria-label="Loading scenario data"
/>
```

**Focus Management:**
- Error state should announce to screen readers
- "Try Again" button should receive focus when error appears

### TypeScript Type Definitions
[Source: docs/architecture/coding-standards.md - TypeScript best practices]

```typescript
type ScenarioType = 'bakery' | 'hotel' | 'tech-startup'

interface GenerationStatus {
  status: 'pending' | 'processing' | 'completed' | 'failed'
  scenarioId?: string
  progress?: number
  message?: string
}

interface LoadingPageProps {
  // If using dynamic routes
  params?: { jobId: string }
}
```

### Performance Considerations
[Source: NFR2 - Page load under 2 seconds]

**Optimization:**
- Minimal JavaScript (no heavy libraries)
- CSS-only animations (Tailwind animate-spin)
- No external API calls until generation starts
- Lightweight spinner (no Lottie or heavy animation frameworks)

**Bundle Size:**
- Loading page should be <50KB total JS
- Use Next.js code splitting (automatic for pages)

### Testing Strategy
[Source: Epic 2 testing patterns]

**Manual Test Checklist:**
- [ ] Navigate from Story 3.1 homepage ‚Üí loading page appears
- [ ] Verify spinner animation is smooth
- [ ] Check status messages update at correct intervals
- [ ] Confirm time remaining countdown works
- [ ] Test successful redirect to `/results/{scenarioId}`
- [ ] Test cancel button navigates back to homepage
- [ ] Simulate timeout (set to 10 seconds for testing)
- [ ] Verify error message displays clearly
- [ ] Test "Try Again" button functionality
- [ ] Mobile responsive (375px width)
- [ ] Desktop responsive (1024px width)

### Known Constraints
[Source: Story 1.6 implementation status]

**Generation Endpoint:**
- `/api/generate` exists from Story 1.6
- Likely synchronous (no async/polling needed)
- Response time: 30-180 seconds (varies by scenario complexity)

**No Status Polling Endpoint:**
- If `/api/generate/status/:jobId` doesn't exist, skip polling
- Use synchronous approach (wait for API response)
- Loading page displays while Story 3.1 waits for response

**Simplified MVP Approach:**
- No job queue or background processing
- No database tracking of generation status
- Direct wait for Claude API response

### Copy Text Guidelines
[Source: PRD - User Interface Design Goals]

**Status Messages:**
- "Generating 1 year of bakery data..." (specific, reassuring)
- "Creating Sales view..." (shows progress)
- "Validating consistency..." (builds trust in data quality)
- "Almost ready..." (manages expectations at end)

**Error Messages:**
- User-friendly, not technical
- "Generation is taking longer than expected. Please try again." (timeout)
- "Something went wrong. Please try again." (generic error)
- Avoid: "Error 500", "API timeout", "Claude API rate limit"

**Tone:**
- Calm and reassuring
- Progress-oriented
- Professional but not robotic

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-19 | 1.0 | Initial story draft for Epic 3 | Bob (Scrum Master) |
| 2025-11-19 | 1.1 | Enhanced with team brainstorm: progress storytelling, value messaging, educational carousel (no poll - deferred to post-PoC) | Bob (Scrum Master) |
